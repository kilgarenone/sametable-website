

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="apple-touch-icon-precomposed"
      sizes="57x57"
      href="assets/favicon/apple-touch-icon-57x57.png"
    />
    <link
      rel="apple-touch-icon-precomposed"
      sizes="114x114"
      href="assets/favicon/apple-touch-icon-114x114.png"
    />
    <link
      rel="apple-touch-icon-precomposed"
      sizes="72x72"
      href="assets/favicon/apple-touch-icon-72x72.png"
    />
    <link
      rel="apple-touch-icon-precomposed"
      sizes="144x144"
      href="assets/favicon/apple-touch-icon-144x144.png"
    />
    <link
      rel="apple-touch-icon-precomposed"
      sizes="60x60"
      href="assets/favicon/apple-touch-icon-60x60.png"
    />
    <link
      rel="apple-touch-icon-precomposed"
      sizes="120x120"
      href="assets/favicon/apple-touch-icon-120x120.png"
    />
    <link
      rel="apple-touch-icon-precomposed"
      sizes="76x76"
      href="assets/favicon/apple-touch-icon-76x76.png"
    />
    <link
      rel="apple-touch-icon-precomposed"
      sizes="152x152"
      href="assets/favicon/apple-touch-icon-152x152.png"
    />
    <link
      rel="icon"
      type="image/png"
      href="assets/favicon/favicon-196x196.png"
      sizes="196x196"
    />
    <link
      rel="icon"
      type="image/png"
      href="assets/favicon/favicon-96x96.png"
      sizes="96x96"
    />
    <link
      rel="icon"
      type="image/png"
      href="assets/favicon/favicon-32x32.png"
      sizes="32x32"
    />
    <link
      rel="icon"
      type="image/png"
      href="assets/favicon/favicon-16x16.png"
      sizes="16x16"
    />
    <link
      rel="icon"
      type="image/png"
      href="assets/favicon/favicon-128.png"
      sizes="128x128"
    />
    <meta name="application-name" content="Sametable" />
    <meta name="msapplication-TileColor" content="#FFFFFF" />
    <meta
      name="msapplication-TileImage"
      content="assets/favicon/mstile-144x144.png"
    />
    <meta
      name="msapplication-square70x70logo"
      content="assets/favicon/mstile-70x70.png"
    />
    <meta
      name="msapplication-square150x150logo"
      content="assets/favicon/mstile-150x150.png"
    />
    <meta
      name="msapplication-wide310x150logo"
      content="assets/favicon/mstile-310x150.png"
    />
    <meta
      name="msapplication-square310x310logo"
      content="assets/favicon/mstile-310x310.png"
    />
    <meta
      name="description"
      content="Sametable is a simple way to manage tasks and projects on anything, and assign them to anyone with the familiarity of a spreadsheet."
    />
    <meta
      name="keywords"
      content="todo list, task list, text editor, list maker, notes, notepad, collaboration, markdown editor, spreadsheet format, spreadsheet view, spreadsheets, federation"
    />
    <meta property="og:title" content="Workspace in Spreadsheets" />
    <meta
      property="og:description"
      content="Sametable is a simple way to manage tasks and projects on anything, and assign them to anyone with the familiarity of a spreadsheet."
    />
    <meta property="og:type" content="website" />
    <meta
      property="og:image"
      content="https://www.dl.dropboxusercontent.com/s/0xon4o5kcvfkigc/sametable_logo_with_text.png"
    />
    <meta property="og:site_name" content="Sametable" />
    <meta property="og:url" content="https://www.sametable.app" />
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:title" content="Workspace in Spreadsheets" />
    <meta property="twitter:site" content="@kheohyeewei" />
    <meta name="twitter:creator" content="@kheohyeewei" />
    <meta
      property="twitter:description"
      content="Sametable is a simple way to manage tasks and projects on anything, and assign them to anyone with the familiarity of a spreadsheet."
    />
    <meta
      property="twitter:image"
      content="https://www.dl.dropboxusercontent.com/s/cs3quf49oev9qvv/home.png"
    />
    <meta
      property="twitter:image:alt"
      content="Sametable is a simple way to manage tasks and projects on anything, and assign them to anyone with the familiarity of a spreadsheet."
    />
    <meta name="theme-color" content="#fcbdaa" />
    <link rel="canonical" href="https://www.sametable.app" />
    <link rel="manifest" href="assets/favicon/manifest.webmanifest" />
    <title>How I built my first SaaS</title>
    <link rel="stylesheet" href="/css/blog.css" />
    <link href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css" rel="stylesheet">
  </head>
  <body>
    
<header style="padding: 20px;">
  <a href="https://www.sametable.app/blog">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      height="28"
      width="28"
      viewBox="0 0 24 24"
      style="margin-right: 10px;"
    >
      <path d="M0 0h24v24H0V0z" fill="none" />
      <path
        d="M10 10.02h5V21h-5V10.02zM17 21h3c1.1 0 2-.9 2-2v-9h-5v11zm3-18H5c-1.1 0-2 .9-2 2v3h19V5c0-1.1-.9-2-2-2zM3 19c0 1.1.9 2 2 2h3V10H3v9z"
      /></svg
  ></a>
</header>
<main>
  <article class="markdown-body" role="article">
    <h1>How I Built My First SaaS</h1>
<h2>Content</h2>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#finding-ideas">Finding Ideas</a></li>
<li><a href="#the-stack">The Stack</a></li>
<li><a href="#repo">Repo</a>
<ul>
<li><a href="#start-dev-locally">Start full-stack development locally</a></li>
</ul>
</li>
<li><a href="#client">Client</a>
<ul>
<li><a href="#client-npm-script">Npm Script</a></li>
<li><a href="#client-env-var">Environment Variables</a></li>
<li><a href="#webpack-babel">Webpack &amp; Babel</a></li>
<li><a href="#web-perf">Web Performance</a></li>
<li><a href="#differential-serving">Differential Serving</a></li>
<li><a href="#fonts">Fonts</a></li>
<li><a href="#icons">Icons</a></li>
<li><a href="#favicon">Favicon</a></li>
<li><a href="#api-calls">API Calls</a></li>
<li><a href="#test-prod-build-locally">Test Production Build Locally</a></li>
<li><a href="#web-security">Security</a></li>
</ul>
</li>
<li><a href="#design">Design</a>
<ul>
<li><a href="#modular-scale">Modular Scale</a></li>
<li><a href="#colors">Colors</a></li>
<li><a href="#css-reset">CSS Reset</a></li>
<li><a href="#a-styling-practice">A Styling Practice</a></li>
<li><a href="#layout">Layout</a></li>
</ul>
</li>
<li><a href="#server">Server</a>
<ul>
<li><a href="#server-file-structure">File Structure</a></li>
<li><a href="#server-npm-script">Npm Script</a></li>
<li><a href="#database">Database</a></li>
<li><a href="#creating-table-schemas">Creating Table Schemas</a></li>
<li><a href="#dropping-a-database">Dropping a database</a></li>
<li><a href="#crafting-sql-queries">Crafting SQL Queries</a></li>
<li><a href="#redis">Redis</a></li>
<li><a href="#error-handling-and-logging">Error Handling &amp; Logging</a></li>
</ul>
</li>
<li><a href="#user-authentication-system">User Authentication System</a>
<ul>
<li><a href="#user-authentication-system-guide">Guide</a></li>
</ul>
</li>
<li><a href="#email">Email</a>
<ul>
<li><a href="#implement-email">Implementation</a></li>
<li><a href="#email-templates">Email Templates</a></li>
</ul>
</li>
<li><a href="#tenancy">Tenancy</a></li>
<li><a href="#domain-name">Domain Name</a></li>
<li><a href="#deployment">Deployment</a>
<ul>
<li><a href="#deploy-nodejs">Deploy Nodejs</a></li>
<li><a href="#deploy-psql">Deploy Postgresql</a></li>
<li><a href="#deploy-redis">Deploy Redis</a></li>
<li><a href="#deploy-file-storage">File Storage</a></li>
</ul>
</li>
<li><a href="#rte">Rich-text Editor</a></li>
<li><a href="#cors">CORS</a></li>
<li><a href="#hosting-spa">Hosting Your SPA</a></li>
<li><a href="#payment-subscription">Payment &amp; Subscription</a>
<ul>
<li><a href="#payment-subscription-guide">Guide</a></li>
<li><a href="#payment-subscription-webhook">Webhook</a></li>
</ul>
</li>
<li><a href="#landing-page">Landing Page</a>
<ul>
<li><a href="#building-landing-page">Building</a></li>
<li><a href="#hosting-landing-page">Hosting</a></li>
</ul>
</li>
<li><a href="#tnc">Terms &amp; Conditions</a></li>
<li><a href="#marketing">Marketing</a></li>
<li><a href="#well-being">Well-being</a></li>
</ul>
<h2>Introduction <a href="#introduction" id="introduction">#</a></h2>
<p>I switched my career to web development back in 2013. I did it for two reasons. First, I noticed I could get lost in building customer-facing products amongst all the colors and endless possibilities for interactivity; so while being reminded by the trite &quot;<em>Find a job you enjoy doing, and you will never have to work a day in your life.</em>&quot;, I thought &quot;<em>Why not make this a job???</em>&quot;. And second, I wanted to make something for myself having spent my teenage years inspired by Web 2.0(Digg.com circa 2005 opened the world for me). The plan was to work on the latter while working in the former.</p>
<p>Turns out, though, the job and the 'Javascript fatigue' ensued to wholly consume me. It also didn't help that I was reckless in my pursue of my ambition having been influenced by my perception of successes from the 'Silicon Valley'. I read Paul Graham's <em>Hackers &amp; Painters</em> and Peter Thiel's <em>Zero to One</em>. I'm properly fired up! I'm hustling. I can do this too!</p>
<p>But nope, I can't. At least not alone. I always was beat after work. I couldn't find a team that share the dreams and values. So meanwhile, I rinse and repeat less than half-baked projects in my free time. I was chronically anxious and depressed. I mellowed out as the years go by. And I began to cultivate a personal philosophy on entrepreneurship and technology that align better with my personality and life circumstances‚Äî Until September 2019.</p>
<p>The fog in the path ahead finally cleared up. I got pretty good at it; the job then became less taxing; I'd reined in on my 'Javascript fatigue'. For the longest time, I had the mental energy, time, and the mindset that allow me to see through a side project. And this time, I start small. I believed I got this!</p>
<p>I was wrong.</p>
<p>Having been a front-end developer for my entire career, I could only go as far as naming the things that I imagined I would need‚Äîa 'server', a 'database', an 'authentication' system, a 'host', a 'domain name', but <em>how</em>... <em>where</em>... and <em>what</em>...<em>I..I don..I don't even</em>... üò≠</p>
<p>Now, I knew my life would have been easier if I'd decided to use one of those abstract tools like 'create-react-app', 'firebase SDK', 'ORM', and 'one-click-deployment' services; the ode of '<em>Don't reinvent the wheel. Iterate fast</em>'. But there were a few things I wanted my decisions to meet:</p>
<ul>
<li>No vendor lock-in ‚Äî This ruled out using the Firebase SDK all over my codebase. Including the 'create-react-app', because ejecting it forces me to inherit and maintain its massive tooling infrastructure.</li>
<li>Simplicity &amp; Minimalistic ‚Äî Cut having to learn new opinionated syntax and pattern. This ruled out 1) Project generators that output complex architecture and layers of boilerplate codes, 2) Using third-party libraries such as 'knex.js' or 'sequelize' ORM.</li>
<li>Pay-as-you-need ‚Äî I wanted to keep my operating cost proportional to the usage level. This ruled out services such as 'one-click-deployment'.</li>
</ul>
<p>To be fair though, I got the following things going for me:</p>
<ul>
<li>I was building a simple SaaS.</li>
<li>I was not anxious to scale, dominate, disrupt etc.</li>
<li>I was still holding my day job.</li>
<li>I had accepted my odds of failure. üíÄ</li>
</ul>
<p>Also keep in mind that:</p>
<ul>
<li>It's a one-man show‚Äîdesign, development, maintenance, marketing, etc.</li>
<li>I'm not a 10x rockstar full-stack programmer.</li>
</ul>
<p><strong>Most importantly</strong>, I wanted to follow through with a guiding principle: Building things <a href="https://alistapart.com/article/responsible-javascript-part-1/"><em>responsibly</em></a>. Although, unsurprisingly, doing so had had a significant impact on my development speed, it had forced me to delineate my motivations:</p>
<ul>
<li>If I had to ship something the soonest possible, unless it's a matter of life and death, then I probably wasn't solving a unique and hard problem, in which case‚Äîassuming I was still on my day job and had zero debt took on‚ÄîWhat is the rush?</li>
<li>And second-guessing from the ethical perspective: Was it even a problem needs solving? What will be the second-order consequences if I solved it? Could my good intentions have been better directed elsewhere?</li>
</ul>
<p>So what follows is everything I'd learned when developing the first project I ever launched called <strong>Sametable</strong> that helps <a href="https://www.sametable.app">managing your work in spreadsheets</a>. From implementing favicon to deploying to a cloud platform, I will share extensive code snippets, best practices, lessons, guides, and key resources. I hope something here would be useful to you. Thanks for reading. ‚ù§Ô∏è</p>
<h2>Finding Ideas <a href="#finding-ideas" id="finding-ideas">#</a></h2>
<p>Well, first of all, you need to know what you want to build. I used to lose sleep over this; thinking and remixing thoughts, hoping for eureka ‚Äî Until I started to look inward:</p>
<ul>
<li>Build things that solve problems that you encounter and piss you off frequently.</li>
<li>Solving the so-called 'pain points' or 'frictions'. Go outside, don't stop listening to people and learn from them.</li>
<li>Be an expert in your domain. Feel its pains. Maybe solve one of them. Seems to me lots of founders founded company related to their domain on which they have built their career and social network.</li>
</ul>
<h2>The Stack <a href="#the-stack" id="the-stack">#</a></h2>
<p>How your stack looks like will depend on how you will render your application. Here is a <a href="https://developers.google.com/web/updates/2019/02/rendering-on-the-web#wrapup">comprehensive</a> discussion about that, but in a nutshell:</p>
<ul>
<li>
<p><strong>Client-side rendering(CSR); SPA; APIs with JSON</strong>
This is perhaps the most popular approach. It's great for building interactive web applications. But <a href="https://macwright.org/2020/05/10/spa-fatigue.html">be aware</a> of its downsides and steps to mitigate them. This is the approach I took, so we will talk more about this in much details.</p>
</li>
<li>
<p><strong>Hybrid CSR; Both client-side and server-side rendering(SSR)</strong>
With this approach, you still build your SPA. But when a user requests your app, for example, the homepage, you would render the homepage's component into its static HTML <strong>in your server</strong> and serve it to the user. Then at the user's browser, <a href="https://reactjs.org/docs/react-dom.html#hydrate">hydration</a> will happen so the whole thing becomes the intended SPA.</p>
<p>The main benefits of this approach are that you get good SEO and users can see your stuff sooner(faster 'First Meaningful Paint'). But there are downsides too. Apart from the extra maintenance costs, we will have to download the same payload twice‚ÄîFirst, the HTML, and second, its Javascript counterpart for the 'hydration'.</p>
<p>The technologies that are adopted for this approach are <a href="https://nextjs.org/">NextJs</a>, <a href="https://nuxtjs.org/">NuxtJs</a>, and <a href="https://www.gatsbyjs.org/">GatsbyJs</a>.</p>
</li>
<li>
<p><strong>Server-side rendering and 'sprinkle :sparkles: it with Javascript'</strong>
This was the old-school way of building on the web!‚ÄîUse PHP to build your templates with data in your server, then bind events handlers to the DOM with jQuery in the browser. This approach might have been ill-suited to build the increasingly complex app that businesses have asked for on the web, but some technologies have emerged to warrant a reconsideration:</p>
<ul>
<li><a href="https://stimulusjs.org/">https://stimulusjs.org/</a></li>
<li><a href="https://github.com/turbolinks/turbolinks">https://github.com/turbolinks/turbolinks</a></li>
<li><a href="https://github.com/phoenixframework/phoenix_live_view">https://github.com/phoenixframework/phoenix_live_view</a></li>
<li>For more, check out this <a href="https://mobile.twitter.com/nateberkopec/status/1260602209475198976">twitter thread</a></li>
</ul>
<p>To be honest, if I could be more patient with myself, I would have gone down this path. This approach is making a comeback in light of the excess of Javascript on this modern web.</p>
</li>
</ul>
<p>The bottom line is: Pick any approach you are already proficient with. But be mindful of the associated downsides, and try to mitigate them before shipping it to your users.</p>
<p>With that, here is the boring stack of Sametable:</p>
<h3>Front-end</h3>
<ul>
<li>Webpack, Babel</li>
<li><strong>Preact</strong></li>
</ul>
<h3>Back-end</h3>
<ul>
<li><strong>Node</strong> ‚Äî API server with ExpressJS</li>
<li><strong>Postgresql</strong> ‚Äî Database</li>
<li><strong>Redis</strong> ‚Äî Store users' session data and cache queries' results.</li>
</ul>
<h3>Hosting</h3>
<ul>
<li><strong>Google Cloud Platform</strong> ‚Äî GAE for hosting Nodejs, GCE for hosting Redis.</li>
<li><strong>Firebase</strong> ‚Äî For hosting my SPA.</li>
</ul>
<img loading="lazy" src="https://i.imgur.com/CA88ijh.png" alt="Sametable architecture" />
<h2>Repo <a href="#repo" id="repo">#</a></h2>
<p><a href="https://github.com/kilgarenone/boileroom">https://github.com/kilgarenone/boileroom</a></p>
<p>This repo contains the structure I'm using to develop my SaaS. I have one folder for the <strong>client</strong> stuff, and another for the <strong>server</strong> stuff:</p>
<pre class="language-json"><code class="language-json">- client<br>    - src<br>      - components<br>      - index.html<br>      - index.js<br>    - package.json<br>    - webpack.config.js<br>    -.env<br>    -.env.development<br>- server<br>    - server.js<br>    - package.json<br>    - .env<br>- package.json<br>- .gitignore<br>- .eslintrc.js<br>- .prettierrc.js<br>- .stylelintrc.js<br></code></pre>
<p>The file structure always aims to be flat, cohesive, and as linear to navigate as possible. Each 'component' is self-contained within a folder with all its constituent files(html|css|js). For example, in a 'Login' route folder:</p>
<pre class="language-xml"><code class="language-xml">- client<br>   - src<br>     - routes<br>       - Login<br>         - Login.js<br>         - Login.scss<br>         - Login.redux.js</code></pre>
<p>I learned this from the <a href="https://angular.io/guide/styleguide#angular-coding-style-guide">Angular2 style guide</a> which has a lot of other good stuff you can take away from. Highly recommended.</p>
<h3>Start Full-stack Development Locally <a href="#start-dev-locally" id="start-dev-locally">#</a></h3>
<p>The <code>package.json</code> at the root has a <strong>npm script</strong> that I will run to boot up <strong>both</strong> my client and server to begin my local development:</p>
<pre class="language-json"><code class="language-json"><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"client"</span><span class="token operator">:</span> <span class="token string">"cd client &amp;&amp; npm run dev"</span><span class="token punctuation">,</span><br>    <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"cd server &amp;&amp; npm run dev"</span><span class="token punctuation">,</span><br>    <span class="token property">"dev"</span><span class="token operator">:</span> <span class="token string">"npm-run-all --parallel server client"</span><br><span class="token punctuation">}</span></code></pre>
<p>Run the following in a terminal at your project's root:</p>
<pre class="language-json"><code class="language-json">npm run dev</code></pre>
<h2>Client <a href="#client" id="client">#</a></h2>
<pre class="language-json"><code class="language-json">- client<br>    - src<br>      - components<br>      - index.html<br>      - index.js<br>    - package.json<br>    - webpack.config.js<br>    -.env<br>    -.env.development</code></pre>
<p>The file structure of the 'client' is quite like that of the 'create-react-app'. The meat of your application code is inside the <code>src</code> folder in which there is a <code>components</code> folder for your functional React components; <code>index.html</code> is your <a href="https://github.com/kilgarenone/boileroom/blob/master/client/config/webpack.development.js#L41-L43">custom template</a> provided to the <a href="https://github.com/jantimon/html-webpack-plugin#options"><code>html-webpack-plugin</code></a>; <a href="https://github.com/kilgarenone/boileroom/blob/master/client/src/index.js"><code>index.js</code></a> is a file as a <a href="https://github.com/kilgarenone/boileroom/blob/master/client/config/webpack.common.js#L12-L15">entry point</a> to Webpack.</p>
<aside class="info">
<p><strong>Note:</strong> I have since restructured my build environment to achieve <a href="#differential-serving">differential serving</a>. Webpack and babel have been organized differently, and npm scripts changed a bit. Everything else remains the same.</p>
</aside>
<h3>Npm Script <a href="#client-npm-script" id="client-npm-script">#</a></h3>
<p>The client's <code>package.json</code> file has two most important npm scripts: 1) <code>dev</code> to start development, 2) <code>build</code> to bundle for production.</p>
<pre class="language-json"><code class="language-json"><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"dev"</span><span class="token operator">:</span> <span class="token string">"cross-env NODE_ENV=development webpack-dev-server"</span><span class="token punctuation">,</span><br>    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"cross-env NODE_ENV=production node_modules/.bin/webpack"</span><br><span class="token punctuation">}</span></code></pre>
<h3>Environment Variables <a href="#client-env-var" id="client-env-var">#</a></h3>
<p>It's a good practice to have a <code>.env</code> file where you define your sensitive values such as API keys and database credentials:</p>
<pre class="language-json"><code class="language-json">SQL_PASSWORD=admin<br>STRIPE_API_KEY=<span class="token number">1234567890</span></code></pre>
<p>A library called <a href="https://www.npmjs.com/package/dotenv">dotenv</a> is usually used to load these variables into our application code for consumption. However, in the context of Webpack, we will use <a href="https://www.npmjs.com/package/dotenv-webpack">dotenv_webpack</a> to do that during compile and build time <a href="https://github.com/kilgarenone/boileroom/blob/master/config/webpack.common.js#L33-L37">as shown here</a>. The variables will then be accessible in the <code>process.env</code> object in your codebase:</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// payment.jsx</span><br><br><span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">STRIPE_API_KEY</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// do stuff</span><br><span class="token punctuation">}</span></code></pre>
<h3>Webpack &amp; Babel <a href="#webpack-babel" id="webpack-babel">#</a></h3>
<p>Webpack is used to lump all my UI components and its dependencies(npm libraries, files like images, fonts, SVG) into appropriate files like <code>.js</code>, <code>.css</code>, <code>.png</code> files. During the bundling, Webpack will run through my <a href="https://github.com/kilgarenone/boileroom/blob/master/client/config/webpack.production.js#L19-L57">babel config</a>, and, if necessary, transpiles the Javascript I have written to an older version(e.g. es5) to support my <a href="https://github.com/kilgarenone/boileroom/blob/master/client/package.json#L13-L27">targeted browsers</a>.</p>
<p>When Webpack has done its job, it will have generated one(or <a href="https://webpack.js.org/concepts/entry-points/#multi-page-application">several</a>) <code>.js</code> and <code>.css</code> files. Then by <a href="https://github.com/kilgarenone/boileroom/blob/master/client/config/webpack.production.js#L189-L202">utilizing</a> a webpack plugin called <a href="https://github.com/jantimon/html-webpack-plugin">'html-webpack-plugin'</a>, references to those JS and CSS files are automatically(default behaviour) injected respectively as <code>&lt;script&gt;</code> and <code>&lt;link</code> in your <code>index.html</code>. Then when a user requests your app in a browser, the 'index.html' is fetched and parsed. When it sees <code>&lt;script&gt;</code> and <code>&lt;link&gt;</code>, it will fetch and execute the referenced assets, and finally your app is <a href="https://preactjs.com/guide/v10/api-reference/#render">rendered</a>(i.e. client-side rendering) in all its glories to the user.</p>
<p>If you are new to Webpack/Babel, I'd suggest learning them from their first principles to slowly build up your configuration of them, instead of copy/paste bits from the web. Nothing wrong with copy/paste configs, but I find it makes more sense doing it once I have the mental models of how things work.</p>
<p>I wrote about the basics here:</p>
<ul>
<li><strong><a href="https://medium.com/@kilgarenone/minimal-webpack-setup-a5f32c5f8960">Webpack</a></strong></li>
</ul>
<p>Once I understood the basics, I started <a href="https://github.com/nystudio107/annotated-webpack-4-config">referring to this resource</a> for more advanced configuration.</p>
<ul>
<li><strong><a href="https://medium.com/@kilgarenone/minimal-babel-setup-b12b563ee2ca">Babel</a></strong></li>
</ul>
<h3>Web Performance <a href="#web-perf" id="web-perf">#</a></h3>
<p>To put it simply, a web app that performs well is good for your <a href="https://developers.google.com/web/fundamentals/performance/why-performance-matters">users and business</a>.</p>
<p>Although web perf is a huge subject that's <a href="https://web.dev/fast/">well documented</a>, I would like to talk about few of the most impactful things I do for web perf(apart from <a href="https://images.guide/">optimizing the images</a> which can account for over 50% of a page's weight).</p>
<h4>Critical rendering path</h4>
<p>We mentioned before that 'html-webpack-plugin' automatically injects references of all Webpack-generated <code>.js</code> and <code>.css</code> files for us in our <code>index.html</code>. But we don't want to do that now to have full control over placement and setting the resource hints. So let's disable the auto-injection:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// webpack.production.js</span><br>plugins<span class="token operator">:</span> <span class="token punctuation">[</span><br>  <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    template<span class="token operator">:</span> settings<span class="token punctuation">.</span>templatePath<span class="token punctuation">,</span><br>    filename<span class="token operator">:</span> <span class="token string">"index.html"</span><span class="token punctuation">,</span><br>    inject<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// we will inject ourselves</span><br>    mode<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre>
<p>And knowing that we can grab Webpack-generated assets from the <a href="https://github.com/jantimon/html-webpack-plugin#writing-your-own-templates"><code>htmlWebpackPlugin.files</code></a> object inside our <code>index.html</code>:</p>
<pre class="language-json"><code class="language-json"><span class="token comment">// example of what you would see if you</span><br><span class="token comment">// console.log(htmlWebpackPlugin.files)</span><br><br><span class="token punctuation">{</span><br>  <span class="token property">"publicPath"</span><span class="token operator">:</span> <span class="token string">"/"</span><span class="token punctuation">,</span><br>  <span class="token property">"js"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>    <span class="token string">"/js/runtime.a201e1a.js"</span><span class="token punctuation">,</span><br>    <span class="token string">"/vendors~app.d8e8c.js"</span><span class="token punctuation">,</span><br>    <span class="token string">"/app.f8fb511.js"</span><span class="token punctuation">,</span><br>    <span class="token string">"/components.3811eb.js"</span><br>  <span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token property">"css"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"/app.5597.css"</span><span class="token punctuation">,</span> <span class="token string">"/components.b49d382.css"</span><span class="token punctuation">]</span><br><span class="token punctuation">}</span></code></pre>
<p>We inject our assets in <code>index.html</code> ourselves:</p>
<pre class="language-html"><code class="language-html">&lt;% if (htmlWebpackPlugin.options.mode === 'production') { %><br><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><br>  <span class="token attr-name">defer</span><br>  <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>&lt;%= htmlWebpackPlugin.files.js.filter(e => /^\/vendors/.test(e))[0] %><span class="token punctuation">"</span></span><br><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><br>  <span class="token attr-name">defer</span><br>  <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>&lt;%= htmlWebpackPlugin.files.js.filter(e => /^\/app/.test(e))[0] %><span class="token punctuation">"</span></span><br><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span><br>  <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span><br>  <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>&lt;%= htmlWebpackPlugin.files.css.filter(e => /app/.test(e))[0] %><span class="token punctuation">"</span></span><br><span class="token punctuation">/></span></span><br><br>&lt;% } %></code></pre>
<p>Note:</p>
<ul>
<li>
<p>We only do this when building for production; we let <code>webpack-dev-server</code> injects for us during local development.</p>
</li>
<li>
<p>We apply the <code>defer</code> attribute on our <code>&lt;script&gt;</code> so that browser will fetch them <em>while</em> parsing our HTML, and only execute the JS once the HTML has been parsed.</p>
<figure>
<img src="https://i.imgur.com/cF7jPjB.png" alt="defer diagram" loading="lazy"/>
<figcaption><a href="https://hacks.mozilla.org/2017/09/building-the-dom-faster-speculative-parsing-async-defer-and-preload/">source</a></figcaption>
</figure>
</li>
</ul>
<h4>Inlining CSS and JS</h4>
<p>If you <a href="https://web.dev/extract-critical-css/#overview-of-tools">managed</a> to separate your <em>critical</em> CSS or you have a tiny JS script, you might want to consider inlining them in <code>&lt;style&gt;</code> and <code>&lt;script&gt;</code>. 'Inlining' means placing corresponding raw content in HTML. This saves network trips, although not being able to cache them is a concern worth factoring in.</p>
<p>Let's inline the <code>runtime.js</code> generated by Webpack as suggested <a href="https://developers.google.com/web/fundamentals/performance/webpack/use-long-term-caching#inline_webpack_runtime_to_save_an_extra_http_request">here</a>. Back in the <code>index.html</code> above, add this snippet:</p>
<pre class="language-html"><code class="language-html"><span class="token comment">&lt;!-- &lt;link> and &lt;script> --></span><br><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><br>  <span class="token operator">&lt;</span><span class="token operator">%=</span> compilation<span class="token punctuation">.</span>assets<span class="token punctuation">[</span>htmlWebpackPlugin<span class="token punctuation">.</span>files<span class="token punctuation">.</span>js<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=></span> <span class="token regex">/runtime/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>htmlWebpackPlugin<span class="token punctuation">.</span>files<span class="token punctuation">.</span>publicPath<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span><span class="token operator">></span><br></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre>
<p>The key was the <code>compilation.assets[&lt;ASSET_FILE_NAME&gt;].source()</code>:</p>
<blockquote>
<ul>
<li>compilation: the webpack <a href="https://webpack.js.org/api/compilation-object/">compilation object</a>. This can be used, for example, to get the contents of processed assets and inline them directly in the page, through <code>compilation.assets[...].source()</code> (see <a href="https://github.com/jantimon/html-webpack-plugin/blob/master/examples/inline/template.pug">the inline template example</a>). (<a href="https://github.com/jantimon/html-webpack-plugin#writing-your-own-templates">source</a>)</li>
</ul>
</blockquote>
<p>You can use this method to inline your critical CSS too:</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css"><br>  &lt;%= compilation.assets[htmlwebpackplugin.files.css.<span class="token function">filter</span><span class="token punctuation">(</span>e => /app/.<span class="token function">test</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span> [0].<span class="token function">substr</span><span class="token punctuation">(</span>htmlWebpackPlugin.files.publicPath.length<span class="token punctuation">)</span> ].<span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span> %><br></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span></code></pre>
<p>For non-critical CSS, you can consider 'preload' them.</p>
<h4>Preload non-critical CSS</h4>
<p>In short:</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span><br>  <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span><br>  <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/path/to/my.css<span class="token punctuation">"</span></span><br>  <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>print<span class="token punctuation">"</span></span><br>  <span class="token attr-name">onload</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>this.media='all'<span class="token punctuation">"</span></span><br><span class="token punctuation">/></span></span></code></pre>
<p><a href="https://timkadlec.com/remembers/2020-02-13-when-css-blocks/">source</a></p>
<p>But let's see how to do this with Webpack.</p>
<p>So I have my non-critical CSS contained in a CSS file, which I specify as its own entry point in Webpack:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span><br>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><br>  entry<span class="token operator">:</span> <span class="token punctuation">{</span><br>    app<span class="token operator">:</span> <span class="token string">"index.js"</span><span class="token punctuation">,</span><br>    components<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"../src/css/components.scss"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>Finally, I inject it above my critical CSS:</p>
<pre class="language-html"><code class="language-html"><span class="token comment">&lt;!-- Preloading non-critical CSS --></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span><br>  <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span><br>  <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>&lt;%= htmlWebpackPlugin.files.css.filter(e => /components/.test(e))[0] %><span class="token punctuation">"</span></span><br>  <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>print<span class="token punctuation">"</span></span><br>  <span class="token attr-name">onload</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>this.media='all'<span class="token punctuation">"</span></span><br><span class="token punctuation">/></span></span><br><br><span class="token comment">&lt;!-- Inlined critical CSS --></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css"><br>  &lt;%= compilation.assets[htmlwebpackplugin.files.css.<span class="token function">filter</span><span class="token punctuation">(</span>e => /app/.<span class="token function">test</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span> [0].<span class="token function">substr</span><span class="token punctuation">(</span>htmlWebpackPlugin.files.publicPath.length<span class="token punctuation">)</span> ].<span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span> %><br></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span></code></pre>
<p>Let's <strong>measure</strong> if, after all this, we have actually done anything good. Measuring the Sametable's <a href="https://web.sametable.app/signup">signup page</a>:</p>
<p><strong>BEFORE</strong>
<img src="https://i.imgur.com/rfy7og8.png" loading="lazy"/></p>
<p><strong>AFTER</strong>
<img src="https://i.imgur.com/n5llJWx.png" loading="lazy"/></p>
<p>Looks like we have improved almost all of the important user-centric metrics(not sure about the First Input Delay..)! üéâ</p>
<p>Here is a <a href="https://www.youtube.com/watch?v=j9LW94EN7n4">good video tutorial</a> about measuring web performance in the Chrome Dev tool.</p>
<h4>Code splitting</h4>
<p>Rather than lump all your app's components, routes and third-party libraries into a single <code>.js</code> file, you should split and load them on-demand based on a user's action at runtime. This will <strong>dramatically</strong> reduce the bundle size of your SPA and reduces initial Javascript processing costs, hence improving metrics like 'First interactive time' and 'First meaningful paint'.</p>
<p>Code splitting is done with the <a href="https://webpack.js.org/guides/code-splitting/#dynamic-imports">'dynamic imports'</a>:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Editor.jsx</span><br><br><span class="token comment">// LAZY-LOAD A GIGANTIC THIRD-PARTY LIBRARY</span><br><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> MarkdownIt <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><br>    <span class="token comment">/* webpackChunkName: "markdown-it" */</span><br>    <span class="token string">"markdown-it"</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">new</span> <span class="token class-name">MarkdownIt</span><span class="token punctuation">(</span><span class="token punctuation">{</span> html<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token comment">/* stuff */</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// OR LAZY-LOAD A COMPONENT BASED ON USER ACTION</span><br><span class="token function-variable function">checkout</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> CheckoutModal <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><br>    <span class="token comment">/* webpackChunkName: "checkoutModal" */</span><br>    <span class="token string">"../routes/CheckoutModal"</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>Another use case for code splitting is to <strong>conditionally load polyfill</strong> for a Web API in a browser that doesn't support it, sparing others that do support it from paying the cost of the polyfill.</p>
<p>For example, if <code>IntersectionObserver</code> isn't supported, we will polyfill it with the <a href="https://www.npmjs.com/package/intersection-observer">'intersection-observer'</a> library:</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// InfiniteScroll.jsx</span><br><br><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token punctuation">(</span>window<span class="token punctuation">.</span>IntersectionObserver <span class="token operator">?</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"intersection-observer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>io <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">window<span class="token punctuation">.</span>IntersectionObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">entries</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      entries<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">entry</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>        <span class="token comment">// do stuff</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> threshold<span class="token operator">:</span> <span class="token number">0.5</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>io<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token comment">/* DOM element */</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<h5>Guide</h5>
<ul>
<li><a href="https://medium.com/@kilgarenone/pragmatic-code-splitting-with-preact-and-webpack-a3d3b19f86a3">https://medium.com/@kilgarenone/pragmatic-code-splitting-with-preact-and-webpack-a3d3b19f86a3</a></li>
</ul>
<h3>Differential Serving <a href="#differential-serving" id="differential-serving">#</a></h3>
<p>You probably have configured your Webpack to build your app targeting both modern and legacy browsers like IE11, and serving every user with the same payload, thus forcing those users who are on modern browsers to pay the cost(parse/compile/execute) of unnecessary polyfills and extraneous transformed codes that are meant to support users on legacy browsers.</p>
<p>'Differential serving' will serve, on one hand, a much leaner code to users on modern browsers, and on the other, a properly polyfilled and transformed code to support users on legacy browsers such as IE11.</p>
<p>Although this approach makes for an even more complex build setup and not without a <a href="https://philipwalton.com/articles/deploying-es2015-code-in-production-today/#double-download-issue">few caveats</a>, the benefits gained(you can find in the resources below) certainly <em>outweigh</em> the costs, unless the majority of your user base was on IE11, in which case, you probably can skip this. But even so, this approach is future-proof as legacy browsers are being phased out.</p>
<h4>Repo</h4>
<p><a href="https://github.com/kilgarenone/differential-serving">https://github.com/kilgarenone/differential-serving</a></p>
<h4>Resources</h4>
<ul>
<li><a href="https://jasonformat.com/modern-script-loading/#option1loaddynamically">https://jasonformat.com/modern-script-loading/#option1loaddynamically</a> ‚Äî A very good overview of different approaches to differential serving. Sametable is on the 'Option-1'.</li>
<li><a href="https://github.com/firsttris/html-webpack-multi-build-plugin">https://github.com/firsttris/html-webpack-multi-build-plugin</a> ‚Äî This Webpack plugin passes the manifest(i.e. assets' reference) of your modern &amp; legacy scripts to 'html-webpack-plugin' so you can access them in your 'index.html'.</li>
<li><a href="https://calendar.perfplanet.com/2018/doing-differential-serving-in-2019/">https://calendar.perfplanet.com/2018/doing-differential-serving-in-2019/</a> ‚Äî I learned here about structuring my babel config with its 'babel.config.js' method.</li>
<li><a href="https://github.com/nystudio107/annotated-webpack-4-config">https://github.com/nystudio107/annotated-webpack-4-config</a> ‚Äî I learned a lot here about structuring my Webpack configs.</li>
</ul>
<h3>Fonts <a href="#fonts" id="fonts">#</a></h3>
<p>Font files can be costly. Take my favorite font <a href="https://rsms.me/inter/">Inter</a> for an example: If I used 3 of its font styles, the total size could get up to 300KB, exacerbating the FOUT and FOIT situations particularly in low-end devices.</p>
<p>To meet my font needs in my projects, I would usually just go with the 'system fonts' that come with the machines:</p>
<pre class="language-css"><code class="language-css"><span class="token selector">body</span> <span class="token punctuation">{</span><br>  <span class="token property">font-family</span><span class="token punctuation">:</span> -apple-system<span class="token punctuation">,</span> BlinkMacSystemFont<span class="token punctuation">,</span> <span class="token string">"Segoe UI"</span><span class="token punctuation">,</span> Roboto<span class="token punctuation">,</span><br>    Oxygen-Sans<span class="token punctuation">,</span> Ubuntu<span class="token punctuation">,</span> Cantarell<span class="token punctuation">,</span> <span class="token string">"Helvetica Neue"</span><span class="token punctuation">,</span> sans-serif<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token selector">code</span> <span class="token punctuation">{</span><br>  <span class="token property">font-family</span><span class="token punctuation">:</span> SFMono-Regular<span class="token punctuation">,</span> Menlo<span class="token punctuation">,</span> Monaco<span class="token punctuation">,</span> Consolas<span class="token punctuation">,</span> <span class="token string">"Liberation Mono"</span><span class="token punctuation">,</span><br>    <span class="token string">"Courier New"</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>But if you must use custom web fonts, consider doing it right:</p>
<ul>
<li>You should <a href="https://kevq.uk/how-to-self-host-your-web-fonts/">host</a> them <a href="https://www.tunetheweb.com/blog/should-you-self-host-google-fonts/">yourself</a>.</li>
<li><a href="https://medium.com/@kilgarenone/subsetting-your-fonts-in-windows-10-using-wsl-bae4fafa35fc">'Font-subsetting'</a> to dramatically reduce the size of the font file.</li>
<li>Go through this <a href="https://www.zachleat.com/web/font-checklist/">checklist</a>.</li>
</ul>
<h3>Icons <a href="#icons" id="icons">#</a></h3>
<p>Icons in Sametable are SVG. There are different ways that I could have done it:</p>
<ul>
<li>Copy and paste the markup of an SVG icon wherever I need it. The downside is it would bloat the HTML and incur parsing costs particularly on mobile.</li>
<li>Request for my SVG icons over the network:<code>&lt;img src=&quot;./tick.svg&quot; /&gt;</code>. Unless an SVG is huge (&gt; 5KB), making a request for every one of them seems a bit much.</li>
<li>Make an icon reusable in the form of a <a href="https://medium.com/@david.gilbertson/icons-as-react-components-de3e33cb8792">React component</a>. The downside is it unnecessarily introduces Javascript and its associated costs.</li>
</ul>
<p>Instead, the solution I opted for my icons was '<strong>SVG sprites</strong>' which is more closer to the nature of SVG itself( <a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Element/use"><code>&lt;use&gt;</code></a> and <a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Element/symbol"><code>&lt;symbol&gt;</code></a>).</p>
<p>Let's see how.</p>
<p>Say there are many places that will use two of our SVG icons. In your <code>index.html</code>:</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.w3.org/2000/svg<span class="token punctuation">"</span></span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">display</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>symbol</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>pin-it<span class="token punctuation">"</span></span> <span class="token attr-name">viewBox</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0 0 96 96<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Give it a title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>desc</span><span class="token punctuation">></span></span>Give it a description for accessibility<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>desc</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>path</span> <span class="token attr-name">d</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>M67.7 40.3c-.3 2.7-2<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>symbol</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>symbol</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>unpin-it<span class="token punctuation">"</span></span> <span class="token attr-name">viewBox</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0 0 96 96<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Un-pin this entity<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>desc</span><span class="token punctuation">></span></span>Click to un-pin this entity<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>desc</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>path</span> <span class="token attr-name">d</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>M67.7 40.3c-.3 2.7-2<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>symbol</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>svg</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></code></pre>
<ol>
<li>Hide the parent SVG element <code>style=&quot;display: none&quot;</code>.</li>
<li>Give each SVG symbol an unique id <code>&lt;symbol id=&quot;unique-id&quot;</code>.</li>
<li>Make sure to define the <code>viewBox</code>(usually already provided), but skip the <code>width</code> and <code>height</code>.</li>
<li>Give it <code>title</code> and <code>desc</code> for accessibility.</li>
<li>And of course, the <code>path</code> data of an icon.</li>
</ol>
<p>And finally, here is how you can use them in your components:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// example.jsx</span><br><br><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token operator">&lt;</span>svg<br>    xmlns<span class="token operator">=</span><span class="token string">"http://www.w3.org/2000/svg"</span><br>    xmlnsXlink<span class="token operator">=</span><span class="token string">"http://www.w3.org/1999/xlink"</span><br>    width<span class="token operator">=</span><span class="token string">"24"</span><br>    height<span class="token operator">=</span><span class="token string">"24"</span><br>  <span class="token operator">></span><br>    <span class="token operator">&lt;</span>use xlinkHref<span class="token operator">=</span><span class="token string">"#pin-it"</span> <span class="token operator">/</span><span class="token operator">></span><br>  <span class="token operator">&lt;</span><span class="token operator">/</span>svg<span class="token operator">></span><br><br><span class="token punctuation">}</span></code></pre>
<ol>
<li>Define the <code>width</code> and <code>height</code> as desired.</li>
<li>Specify the <code>id</code> of the <code>&lt;symbol&gt;</code>: <code>&lt;use xlinkHref=&quot;#pin-it&quot; /&gt;</code>.</li>
</ol>
<h4>Lazy load SVG sprites</h4>
<p>Rather than having your SVG symbols in the <code>index.html</code>, you could put them in a <code>.svg</code> file which is loaded only when needed:</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.w3.org/2000/svg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>symbol</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>header-1<span class="token punctuation">"</span></span> <span class="token attr-name">viewBox</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0 0 26 24<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Header 1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>desc</span><span class="token punctuation">></span></span>Toggle a h1 header<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>desc</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span> <span class="token attr-name">x</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">y</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>20<span class="token punctuation">"</span></span> <span class="token attr-name">font-weight</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>600<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>H1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>symbol</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>symbol</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>header-2<span class="token punctuation">"</span></span> <span class="token attr-name">viewBox</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0 0 26 24<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Header 2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>desc</span><span class="token punctuation">></span></span>Toggle a h2 header<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>desc</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span> <span class="token attr-name">x</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">y</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>20<span class="token punctuation">"</span></span> <span class="token attr-name">font-weight</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>600<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>H2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>symbol</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>svg</span><span class="token punctuation">></span></span></code></pre>
<p>Put that file in <code>client/src/assets</code>:</p>
<pre class="language-xml"><code class="language-xml">- client<br>  - src<br>    - assets<br>      - svg-sprites.svg</code></pre>
<p>Finally, to use one of the symbols in the file:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Editor.js</span><br><br><span class="token keyword">import</span> svgSprites <span class="token keyword">from</span> <span class="token string">"../../assets/svg-sprites.svg"</span><span class="token punctuation">;</span><br><br><span class="token comment">/* component stuff */</span><br><br><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token operator">&lt;</span>button type<span class="token operator">=</span><span class="token string">"button"</span><span class="token operator">></span><br>      <span class="token operator">&lt;</span>svg<br>        xmlns<span class="token operator">=</span><span class="token string">"http://www.w3.org/2000/svg"</span><br>        xmlnsXlink<span class="token operator">=</span><span class="token string">"http://www.w3.org/1999/xlink"</span><br>        width<span class="token operator">=</span><span class="token string">"24"</span><br>        height<span class="token operator">=</span><span class="token string">"24"</span><br>      <span class="token operator">></span><br>        <span class="token operator">&lt;</span>use xlinkHref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>svgSprites<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">#header-1</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><br>      <span class="token operator">&lt;</span><span class="token operator">/</span>svg<span class="token operator">></span><br>    <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre>
<p>And a browser will, during runtime, fetch the <code>.svg</code> file if it hadn't already.</p>
<p>And there you have it! No more plastering those lengthy <code>path</code> data all over the place.</p>
<h4>Sources of icons</h4>
<ul>
<li><a href="https://material.io/resources/icons/?style=baseline">https://material.io/resources/icons/?style=baseline</a></li>
<li><a href="https://logomakr.com/">https://logomakr.com/</a></li>
<li><a href="https://github.com/wmira/react-icons-kit#bundled-icon-sets">https://github.com/wmira/react-icons-kit#bundled-icon-sets</a> (has a nice list of sources)</li>
</ul>
<h4>References</h4>
<ul>
<li><a href="https://css-tricks.com/mega-list-svg-information/#svg-icons">https://css-tricks.com/mega-list-svg-information/#svg-icons</a></li>
</ul>
<h3>Favicon <a href="#favicon" id="favicon">#</a></h3>
<p>If I hadn't disabled the <code>inject</code> option of 'html-webpack-plugin', I would have used a plugin called <a href="https://github.com/jantimon/favicons-webpack-plugin">'favicons-webpack-plugin'</a> that automatically generates all types of favicons(beware it's a lot!), and inject them in my <code>index.html</code>:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span><br><br>plugins<span class="token operator">:</span> <span class="token punctuation">[</span><br>  <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 'inject' is true by default</span><br>  <span class="token comment">// must come after html-webpack-plugin</span><br>  <span class="token keyword">new</span> <span class="token class-name">FaviconsWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    logo<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"../src/assets/logo.svg"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    prefix<span class="token operator">:</span> <span class="token string">"icons-[hash]/"</span><span class="token punctuation">,</span><br>    persistentCache<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>    inject<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>    favicons<span class="token operator">:</span> <span class="token punctuation">{</span><br>      appName<span class="token operator">:</span> <span class="token string">"Sametable"</span><span class="token punctuation">,</span><br>      appDescription<span class="token operator">:</span> <span class="token string">"Manage your tasks in spreadsheets"</span><span class="token punctuation">,</span><br>      developerName<span class="token operator">:</span> <span class="token string">"Kheoh Yee Wei"</span><span class="token punctuation">,</span><br>      developerURL<span class="token operator">:</span> <span class="token string">"https://kheohyeewei.com"</span><span class="token punctuation">,</span> <span class="token comment">// prevent retrieving from the nearest package.json</span><br>      theme_color<span class="token operator">:</span> <span class="token string">"#fcbdaa"</span><span class="token punctuation">,</span><br>      <span class="token comment">// specify the vendors that you want favicon for</span><br>      icons<span class="token operator">:</span> <span class="token punctuation">{</span><br>        coast<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><br>        yandex<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><br>      <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre>
<p>But since I had disabled the auto-injection, here is how I handle my favicon:</p>
<ol>
<li>
<p>Go to <a href="https://realfavicongenerator.net/">https://realfavicongenerator.net/</a></p>
<ul>
<li>Provide your logo in SVG format.</li>
<li>Select the 'Version/Refresh' option to enable cache-busting your favicon asset in your users' browser.</li>
<li>Complete the instructions at the end. You can store your favicons in any folder in your project.</li>
</ul>
</li>
<li>
<p>Use <a href="https://webpack.js.org/plugins/copy-webpack-plugin/">'copy-webpack-plugin'</a> to copy all your favicon assets generated from Step-1, from the folder you store them(in my case, <code>src/assets/favicon</code>) to my Webpack's output's <a href="https://github.com/kilgarenone/boileroom/blob/master/client/config/webpack.production.js#L140">path</a> (<a href="https://github.com/webpack-contrib/copy-webpack-plugin#to">default behaviour</a>), so that they will be accessible from the root(i.e. https://example.com/favicon.ico).</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span><br><span class="token keyword">const</span> CopyWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"copy-webpack-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">CopyWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token keyword">from</span><span class="token operator">:</span> <span class="token string">"src/assets/favicon"</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre>
</li>
</ol>
<p>And that's it!</p>
<h3>API Calls <a href="#api-calls" id="api-calls">#</a></h3>
<p>A client needs to communicate with a server to do the works of 'CRUD'- Create, Read, Update, and Delete:</p>
<img src="https://i.imgur.com/VjAWItp.png" alt="client and server communication diagram" loading="lazy"/>
<p>Here is my hopefully easy to understand <code>api.js</code>:</p>
<details>
  <summary>API WRAPPER</summary>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span> route <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"preact-router"</span><span class="token punctuation">;</span><br><br><span class="token keyword">function</span> <span class="token function">checkStatus</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> responseCode <span class="token operator">=</span> response<span class="token punctuation">.</span>status<span class="token punctuation">;</span><br><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>responseCode <span class="token operator">>=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> responseCode <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> response<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token comment">// handle user not authorized scenario</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>responseCode <span class="token operator">===</span> <span class="token number">401</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    response<br>      <span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">json</span><span class="token punctuation">)</span> <span class="token operator">=></span><br>        <span class="token function">route</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/signin</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>json<span class="token punctuation">.</span>refererUri <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">?dest=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>json<span class="token punctuation">.</span>refererUri<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">""</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token comment">// pass along error response to the 'catch' block of your await/async try &amp; catch block</span><br>  <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">json</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>      status<span class="token operator">:</span> responseCode<span class="token punctuation">,</span><br>      ok<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><br>      statusText<span class="token operator">:</span> response<span class="token punctuation">.</span>statusText<span class="token punctuation">,</span><br>      body<span class="token operator">:</span> json<span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">handleError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  error<span class="token punctuation">.</span>response <span class="token operator">=</span> <span class="token punctuation">{</span><br>    status<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><br>    statusText<span class="token operator">:</span><br>      <span class="token string">"Cannot connect. Please make sure you are connected to internet."</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token keyword">throw</span> error<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">parseJSON</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">204</span> <span class="token operator">||</span> response<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">205</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> options<span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>handleError<span class="token punctuation">)</span> <span class="token comment">// handle network issues</span><br>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>checkStatus<span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>parseJSON<span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      <span class="token keyword">throw</span> e<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">api</span><span class="token punctuation">(</span><span class="token parameter">endPoint<span class="token punctuation">,</span> userOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> url <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">API_BASE_URL</span> <span class="token operator">+</span> endPoint<span class="token punctuation">;</span><br><br>  <span class="token comment">// to pass along our auth cookie to server</span><br>  userOptions<span class="token punctuation">.</span>credentials <span class="token operator">=</span> <span class="token string">"include"</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> defaultHeaders <span class="token operator">=</span> <span class="token punctuation">{</span><br>    <span class="token string">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span><br>    Accept<span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>userOptions<span class="token punctuation">.</span>body <span class="token keyword">instanceof</span> <span class="token class-name">File</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">,</span> userOptions<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    userOptions<span class="token punctuation">.</span>body <span class="token operator">=</span> formData<span class="token punctuation">;</span><br>    <span class="token comment">// let browser set content-type to multipart/etc.</span><br>    <span class="token keyword">delete</span> defaultHeaders<span class="token punctuation">[</span><span class="token string">"Content-Type"</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>userOptions<span class="token punctuation">.</span>body <span class="token keyword">instanceof</span> <span class="token class-name">FormData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// let browser set content-type to multipart</span><br>    <span class="token keyword">delete</span> defaultHeaders<span class="token punctuation">[</span><span class="token string">"Content-Type"</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><br>    <span class="token operator">...</span>userOptions<span class="token punctuation">,</span><br>    headers<span class="token operator">:</span> <span class="token punctuation">{</span><br>      <span class="token operator">...</span>defaultHeaders<span class="token punctuation">,</span><br>      <span class="token operator">...</span>userOptions<span class="token punctuation">.</span>headers<span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token function">request</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
</details>
<p>There is almost nothing new to learn to start using this API module if you have used the native <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch"><code>fetch</code></a> before.</p>
<h4>Usage</h4>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Home.jsx</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> api <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../lib/api"</span><span class="token punctuation">;</span><br><br><span class="token keyword">async</span> <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">try</span> <span class="token punctuation">{</span><br>    <span class="token comment">// POST-ing data</span><br>    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">api</span><span class="token punctuation">(</span><br>      <span class="token string">'/projects/save/121212121'</span><span class="token punctuation">,</span><br>      <span class="token punctuation">{</span><br>        method<span class="token operator">:</span> <span class="token string">'PUT'</span><span class="token punctuation">,</span><br>        body<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>dataObject<span class="token punctuation">)</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">)</span><br><br>    <span class="token comment">// or GET-ting data</span><br>    <span class="token keyword">const</span> <span class="token punctuation">{</span> myWorkspaces <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">api</span><span class="token punctuation">(</span><span class="token string">'/users/home'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// handle Promise.reject passed from api.js</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>But if you preferred to use a library to handle your HTTP calls, I'd recommend <a href="https://github.com/developit/redaxios">'redaxios'</a> which not only shares API with the popular <a href="https://www.npmjs.com/package/axios">axios</a>, it's much more lightweight.</p>
<h3>Test Production Build Locally <a href="#test-prod-build-locally" id="test-prod-build-locally">#</a></h3>
<p>I would always build my client app locally to test and measure in my browser before I deploy to the cloud.</p>
<p>I have a npm script(<code>npm run test-build</code>) in the <code>package.json</code> of the 'client' folder that will build and serve it on a local web server so I can play with it in my browser at http://localhost:5000:</p>
<pre class="language-json"><code class="language-json"><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"test-build"</span><span class="token operator">:</span> <span class="token string">"cross-env NODE_ENV=production TEST_RUN=true node_modules/.bin/webpack &amp;&amp; npm run serve"</span><span class="token punctuation">,</span><br>    <span class="token property">"serve"</span><span class="token operator">:</span> <span class="token string">"ws --spa index.html --directory dist --port 5000 --hostname localhost"</span><br>  <span class="token punctuation">}</span></code></pre>
<p>The app is served using a tool called <a href="https://www.npmjs.com/package/local-web-server">'local-web-server'</a>. It's so far the only one I find works perfectly for a SPA.</p>
<h3>Security <a href="#web-security" id="web-security">#</a></h3>
<p>Consider adding the <a href="https://developers.google.com/web/fundamentals/security/csp/">CSP</a> security headers.</p>
<p>To add headers in firebase: <a href="https://firebase.google.com/docs/hosting/full-config#headers">https://firebase.google.com/docs/hosting/full-config#headers</a></p>
<p>Sample of CSP headers in your <code>firebase.json</code>:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>  <span class="token property">"source"</span><span class="token operator">:</span> <span class="token string">"**"</span><span class="token punctuation">,</span><br>  <span class="token property">"headers"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>    <span class="token punctuation">{</span><br>      <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"Strict-Transport-Security"</span><span class="token punctuation">,</span><br>      <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"max-age=63072000; includeSubdomains; preload"</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">{</span><br>      <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"Content-Security-Policy"</span><span class="token punctuation">,</span><br>      <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"default-src 'none'; img-src 'self'; script-src 'self'; style-src 'self'; object-src 'none'"</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">{</span> <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"X-Content-Type-Options"</span><span class="token punctuation">,</span> <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"nosniff"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">{</span> <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"X-Frame-Options"</span><span class="token punctuation">,</span> <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"DENY"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">{</span> <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"X-XSS-Protection"</span><span class="token punctuation">,</span> <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"1; mode=block"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">{</span> <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"Referrer-Policy"</span><span class="token punctuation">,</span> <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"same-origin"</span> <span class="token punctuation">}</span><br>  <span class="token punctuation">]</span><br><span class="token punctuation">}</span></code></pre>
<p>If you use Stripe, make sure you add their CSP directives too:
<a href="https://stripe.com/docs/security/guide#content-security-policy">https://stripe.com/docs/security/guide#content-security-policy</a></p>
<p>Finally, make sure you get an <strong>A</strong> <a href="https://observatory.mozilla.org/">here</a> and pat yourself on the back!</p>
<h2>Design <a href="#design" id="design">#</a></h2>
<p>I will explore a few concepts that helped structure my design to be coherent.</p>
<h3>Modular Scale <a href="#modular-scale" id="modular-scale">#</a></h3>
<p>Your design will demand less effort from your users to make sense of when it flows according to a 'modular scale' that specifies a scale of spaces or sizes that each increment with a certain ratio.</p>
<figure>
<img src="https://i.imgur.com/WWl6KuB.png" loading="lazy" alt="modular scale illustration" />
<figcaption><em>Figure: Modular scale</em></figcaption>
</figure>
<p>One way to create a scale is with CSS <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/Using_CSS_custom_properties">'Custom Properties'</a>(credits to view-source <a href="https://every-layout.dev/">every-layout.dev</a>):</p>
<pre class="language-css"><code class="language-css"><span class="token selector">:root</span> <span class="token punctuation">{</span><br>  <span class="token property">--ratio</span><span class="token punctuation">:</span> 1.414<span class="token punctuation">;</span><br>  <span class="token property">--s-3</span><span class="token punctuation">:</span> <span class="token function">calc</span><span class="token punctuation">(</span><span class="token function">var</span><span class="token punctuation">(</span>--s0<span class="token punctuation">)</span> / <span class="token function">var</span><span class="token punctuation">(</span>--ratio<span class="token punctuation">)</span> / <span class="token function">var</span><span class="token punctuation">(</span>--ratio<span class="token punctuation">)</span> / <span class="token function">var</span><span class="token punctuation">(</span>--ratio<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token property">--s-2</span><span class="token punctuation">:</span> <span class="token function">calc</span><span class="token punctuation">(</span><span class="token function">var</span><span class="token punctuation">(</span>--s0<span class="token punctuation">)</span> / <span class="token function">var</span><span class="token punctuation">(</span>--ratio<span class="token punctuation">)</span> / <span class="token function">var</span><span class="token punctuation">(</span>--ratio<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token property">--s-1</span><span class="token punctuation">:</span> <span class="token function">calc</span><span class="token punctuation">(</span><span class="token function">var</span><span class="token punctuation">(</span>--s0<span class="token punctuation">)</span> / <span class="token function">var</span><span class="token punctuation">(</span>--ratio<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token property">--s0</span><span class="token punctuation">:</span> 1rem<span class="token punctuation">;</span><br>  <span class="token property">--s1</span><span class="token punctuation">:</span> <span class="token function">calc</span><span class="token punctuation">(</span><span class="token function">var</span><span class="token punctuation">(</span>--s0<span class="token punctuation">)</span> * <span class="token function">var</span><span class="token punctuation">(</span>--ratio<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token property">--s2</span><span class="token punctuation">:</span> <span class="token function">calc</span><span class="token punctuation">(</span><span class="token function">var</span><span class="token punctuation">(</span>--s0<span class="token punctuation">)</span> * <span class="token function">var</span><span class="token punctuation">(</span>--ratio<span class="token punctuation">)</span> * <span class="token function">var</span><span class="token punctuation">(</span>--ratio<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token property">--s3</span><span class="token punctuation">:</span> <span class="token function">calc</span><span class="token punctuation">(</span><span class="token function">var</span><span class="token punctuation">(</span>--s0<span class="token punctuation">)</span> * <span class="token function">var</span><span class="token punctuation">(</span>--ratio<span class="token punctuation">)</span> * <span class="token function">var</span><span class="token punctuation">(</span>--ratio<span class="token punctuation">)</span> * <span class="token function">var</span><span class="token punctuation">(</span>--ratio<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>If you don't know what scale to use, just <a href="https://www.modularscale.com/">pick a scale</a> that fits closest to your design and <strong>stick to it</strong>.</p>
<p>Then I would create a bunch of utility classes, each associated with a scale, in a file call <code>spacing.scss</code>. I will use them to space my UI elements across a project:</p>
<pre class="language-css"><code class="language-css"><span class="token selector">.mb-1</span> <span class="token punctuation">{</span><br>  <span class="token property">margin-bottom</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--s1<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><span class="token selector">.mb-2</span> <span class="token punctuation">{</span><br>  <span class="token property">margin-bottom</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--s2<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><span class="token selector">.mr-1</span> <span class="token punctuation">{</span><br>  <span class="token property">margin-right</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--s1<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><span class="token selector">.mr--1</span> <span class="token punctuation">{</span><br>  <span class="token property">margin-right</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--s-1<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>Notice that I try to define the spacing only in the <code>right</code> and <code>bottom</code> direction as <a href="https://csswizardry.com/2012/06/single-direction-margin-declarations/">suggested here</a>.</p>
<p>In my experience, it's better to not bake in any spacing definitions in your UI components:</p>
<p><strong>DON'T</strong></p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Button.scss</span><br><span class="token punctuation">.</span>btn <span class="token punctuation">{</span><br>  margin<span class="token operator">:</span> <span class="token number">10</span>px<span class="token punctuation">;</span> <span class="token comment">// a default spacing; annoying to have in most cases</span><br>  font<span class="token operator">-</span>style<span class="token operator">:</span> normal<span class="token punctuation">;</span><br>  border<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span><br>  background<span class="token operator">-</span>color<span class="token operator">:</span> transparent<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// Button.jsx</span><br><span class="token keyword">import</span> s <span class="token keyword">from</span> <span class="token string">'./Button.scss'</span><span class="token punctuation">;</span><br><br><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">Button</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>children<span class="token punctuation">,</span> <span class="token operator">...</span>props<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token operator">&lt;</span>button <span class="token keyword">class</span><span class="token operator">=</span><span class="token punctuation">{</span>s<span class="token punctuation">.</span>btn<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// Usage</span><br><span class="token operator">&lt;</span>Button <span class="token operator">/</span><span class="token operator">></span></code></pre>
<p><strong>DO</strong></p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Button.scss</span><br><span class="token punctuation">.</span>btn <span class="token punctuation">{</span><br>  font<span class="token operator">-</span>style<span class="token operator">:</span> normal<span class="token punctuation">;</span><br>  border<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span><br>  background<span class="token operator">-</span>color<span class="token operator">:</span> transparent<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// Button.jsx</span><br><span class="token keyword">import</span> s <span class="token keyword">from</span> <span class="token string">'./Button.scss'</span><span class="token punctuation">;</span><br><br><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">Button</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>children<span class="token punctuation">,</span> className<span class="token punctuation">,</span> <span class="token operator">...</span>props<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token operator">&lt;</span>button <span class="token keyword">class</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>s<span class="token punctuation">.</span>btn<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>className<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// Usage</span><br><span class="token comment">// Pass your spacing utility classes when building your pages</span><br><span class="token operator">&lt;</span>Button className<span class="token operator">=</span><span class="token string">"mr-1 pb-1"</span><span class="token operator">></span>Sign Up<span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">></span></code></pre>
<h3>Colors <a href="#colors" id="colors">#</a></h3>
<p>There are many color palette tools out there. But the one from <a href="https://material.io/design/color/the-color-system.html#tools-for-picking-colors">Material</a> is the one I always go to for my colors.</p>
<p>Then I will define them as CSS Custom Properties again:</p>
<pre class="language-css"><code class="language-css"><span class="token selector">:root</span> <span class="token punctuation">{</span><br>  <span class="token property">--black-100</span><span class="token punctuation">:</span> #0b0c0c<span class="token punctuation">;</span><br>  <span class="token property">--black-80</span><span class="token punctuation">:</span> #424242<span class="token punctuation">;</span><br>  <span class="token property">--black-60</span><span class="token punctuation">:</span> #555759<span class="token punctuation">;</span><br>  <span class="token property">--black-50</span><span class="token punctuation">:</span> #626a6e<span class="token punctuation">;</span><br><br>  <span class="token property">font-size</span><span class="token punctuation">:</span> 105%<span class="token punctuation">;</span><br>  <span class="token property">color</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--black-100<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<h3>CSS Reset <a href="#css-reset" id="css-reset">#</a></h3>
<p>The purpose of a 'CSS reset' is to remove the default styling of common browsers.</p>
<p>There are quite a few of those out there. Beware that some can get quite opinionated and potentially gives you more headaches than its worth. Here is a popular one: <a href="https://meyerweb.com/eric/tools/css/reset/reset.css">https://meyerweb.com/eric/tools/css/reset/reset.css</a></p>
<p>Here is mine:</p>
<pre class="language-css"><code class="language-css"><span class="token selector">*,<br>*::before,<br>*::after</span> <span class="token punctuation">{</span><br>  <span class="token property">box-sizing</span><span class="token punctuation">:</span> border-box<span class="token punctuation">;</span><br>  <span class="token property">overflow-wrap</span><span class="token punctuation">:</span> break-word<span class="token punctuation">;</span><br>  <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span><br>  <span class="token property">padding</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span><br>  <span class="token property">border</span><span class="token punctuation">:</span> 0 solid<span class="token punctuation">;</span><br>  <span class="token property">font-family</span><span class="token punctuation">:</span> inherit<span class="token punctuation">;</span><br>  <span class="token property">color</span><span class="token punctuation">:</span> inherit<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">/* Set core body defaults */</span><br><span class="token selector">body</span> <span class="token punctuation">{</span><br>  <span class="token property">scroll-behavior</span><span class="token punctuation">:</span> smooth<span class="token punctuation">;</span><br>  <span class="token property">text-rendering</span><span class="token punctuation">:</span> optimizeLegibility<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">/* Make images easier to work with */</span><br><span class="token selector">img</span> <span class="token punctuation">{</span><br>  <span class="token property">max-width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">/* Inherit fonts for inputs and buttons */</span><br><span class="token selector">button,<br>input,<br>textarea,<br>select</span> <span class="token punctuation">{</span><br>  <span class="token property">color</span><span class="token punctuation">:</span> inherit<span class="token punctuation">;</span><br>  <span class="token property">font</span><span class="token punctuation">:</span> inherit<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>You could also consider using <a href="https://github.com/csstools/postcss-normalize">postcss-normalize</a> that generates one according to your targeted browsers.</p>
<h3>A Styling Practice <a href="#a-styling-practice" id="a-styling-practice">#</a></h3>
<p>I always try to style at the <strong>tag</strong>-level first before bringing out the big gun if necessary, in my case, <a href="https://github.com/css-modules/css-modules">'CSS Modules'</a>, for encapsulating styles per component:</p>
<pre class="language-xml"><code class="language-xml">- src<br>  - routes<br>    - SignIn<br>      - SignIn.js<br>      - SignIn.scss</code></pre>
<p>The <code>SignIn.scss</code> contains CSS that pertains only to the <code>&lt;SignIn /&gt;</code> component.</p>
<p>Furthermore, I don't use the CSS libraries popular in the React ecosystem such as 'styled-components' and 'emotion'. I try to <strong>use pure HTML and CSS whenever I can, and only let Preact handle the DOM and state updates</strong> for me.</p>
<p>For example, for the <code>&lt;input/&gt;</code> element:</p>
<pre class="language-css"><code class="language-css"><span class="token selector">// index.scss<br><br>label</span> <span class="token punctuation">{</span><br>  <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span><br>  <span class="token property">color</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--black-100<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token property">font-weight</span><span class="token punctuation">:</span> 600<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token selector">input</span> <span class="token punctuation">{</span><br>  <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span><br>  <span class="token property">font-weight</span><span class="token punctuation">:</span> 400<span class="token punctuation">;</span><br>  <span class="token property">font-style</span><span class="token punctuation">:</span> normal<span class="token punctuation">;</span><br>  <span class="token property">border</span><span class="token punctuation">:</span> 2px solid <span class="token function">var</span><span class="token punctuation">(</span>--black-100<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token property">box-shadow</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span><br>  <span class="token property">outline</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span><br>  <span class="token property">appearance</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token selector">input:focus</span> <span class="token punctuation">{</span><br>  <span class="token property">box-shadow</span><span class="token punctuation">:</span> inset 0 0 0 2px<span class="token punctuation">;</span><br>  <span class="token property">outline</span><span class="token punctuation">:</span> 3px solid #fd0<span class="token punctuation">;</span><br>  <span class="token property">outline-offset</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>Then using it in a JSX file with its vanilla tag:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// SignIn.js</span><br><br><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control"</span><span class="token operator">></span><br>      <span class="token operator">&lt;</span>label htmlFor<span class="token operator">=</span><span class="token string">"email"</span><span class="token operator">></span><br>        Email<span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><br>        <span class="token operator">&lt;</span>strong<span class="token operator">></span><br>          <span class="token operator">&lt;</span>abbr title<span class="token operator">=</span><span class="token string">"This field is required"</span><span class="token operator">></span><span class="token operator">*</span><span class="token operator">&lt;</span><span class="token operator">/</span>abbr<span class="token operator">></span><br>        <span class="token operator">&lt;</span><span class="token operator">/</span>strong<span class="token operator">></span><br>      <span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">></span><br>      <span class="token operator">&lt;</span>input<br>        required<br>        value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>email<span class="token punctuation">}</span><br>        type<span class="token operator">=</span><span class="token string">"email"</span><br>        id<span class="token operator">=</span><span class="token string">"email"</span><br>        name<span class="token operator">=</span><span class="token string">"email"</span><br>        placeholder<span class="token operator">=</span><span class="token string">"e.g. sara@widgetco.com"</span><br>      <span class="token operator">/</span><span class="token operator">></span><br>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre>
<h3>Layout <a href="#layout" id="layout">#</a></h3>
<p>I use <strong>CSS Flexbox</strong> for layout works in Sametable. There was no need for any CSS frameworks. Learn CSS Flexbox from its first principles to do more with less code. Plus, in many cases, the result would already be responsive thanks to the layout algorithms, saving those <code>@media</code> queries.</p>
<p>Let's see how to build a common layout in Flexbox with a minimal amount of CSS:</p>
<img src="https://i.imgur.com/PTCrd0K.png" alt="sidebar and content layout" loading="lazy"/>
<p class="codepen" data-height="265" data-theme-id="dark" data-default-tab="html,result" data-user="kilgarenone" data-slug-hash="mdeLwvx" data-preview="true" style="height: 265px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; border: 2px solid; margin: 1em 0; padding: 1em;" data-pen-title="Sidebar/Content layout">
  <span>See the Pen <a href="https://codepen.io/kilgarenone/pen/mdeLwvx">
  Sidebar/Content layout</a> by Ahwei (<a href="https://codepen.io/kilgarenone">@kilgarenone</a>)
  on <a href="https://codepen.io">CodePen</a>.</span>
</p>
<script async src="https://static.codepen.io/assets/embed/ei.js"></script>
<h4>Resources</h4>
<ul>
<li><a href="https://flexboxfroggy.com/">Flexbox froggy</a></li>
<li><a href="https://www.freecodecamp.org/news/understanding-flexbox-everything-you-need-to-know-b4013d4dc9af/">Everything you need to know about flexbox</a></li>
</ul>
<h2>Server <a href="#server" id="server">#</a></h2>
<pre class="language-json"><code class="language-json">- server<br>  - server.js<br>  - package.json<br>  - .env</code></pre>
<p>The <a href="https://github.com/kilgarenone/boileroom/tree/master/server">server</a> is run on NodeJS(ExpressJS framework) to serve all my <strong>API</strong> endpoints.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Example endpoint: https://example.com/api/tasks/save/12345</span><br>router<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"/save/:taskId"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>The <a href="https://github.com/kilgarenone/boileroom/blob/master/server/server.js"><code>server.js</code></a> contains the <a href="https://expressjs.com/en/starter/hello-world.html">familiar</a> codes to start a Nodejs server.</p>
<h3>File Structure <a href="#server-file-structure" id="server-file-structure">#</a></h3>
<p>I'm grateful for this digestible <a href="https://node-postgres.com/guides/project-structure">guide</a> about project structure, allowing me to hunker down quickly to build out my API.</p>
<h3>Npm Script <a href="#server-npm-script" id="server-npm-script">#</a></h3>
<p>In the <code>package.json</code> inside the 'server' folder, there is a npm script that will start your server for you:</p>
<pre class="language-json"><code class="language-json"><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>  <span class="token property">"dev"</span><span class="token operator">:</span> <span class="token string">"nodemon -r dotenv/config server.js"</span><span class="token punctuation">,</span><br>  <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"node server.js"</span><br><span class="token punctuation">}</span></code></pre>
<ul>
<li>
<p>The <code>dev</code> script <a href="https://www.npmjs.com/package/dotenv#preload">'preload'</a> dotenv as suggested <a href="https://medium.com/the-node-js-collection/making-your-node-js-work-everywhere-with-environment-variables-2da8cdf6e786#b1af">here</a>. And that's it‚Äî You will have access to the env variables defined in the <code>.env</code> file from the <code>process.env</code> object.</p>
</li>
<li>
<p>The <code>start</code> script is used to start our Nodejs server in production. In my case, GCP will run this script to bootup my Nodejs.</p>
</li>
</ul>
<h3>Database <a href="#database" id="database">#</a></h3>
<p>I use <strong>Postgresql</strong> as my database. Then I use <a href="https://node-postgres.com/">'node-postgres'</a>(a.k.a <code>pg</code>) library to connect my Nodejs to the database. Once that's done, I can do CRUD works between my API endpoints and the database.</p>
<h4>Setup</h4>
<p>For local development:</p>
<ol>
<li>
<p>Download <a href="https://www.enterprisedb.com/downloads/postgres-postgresql-downloads">Postgresql here</a>. Get the latest version. Leave everything as it is. Remember the password you set. Then,</p>
<ul>
<li>Open 'pgAdmin'. It's a browser application.</li>
<li>Create a database for you app:
<img src="https://i.imgur.com/trcAaSi.png" loading="lazy"/></li>
</ul>
</li>
<li>
<p>Define a set of environment variables in the <code>.env</code> file:</p>
<pre class="language-json"><code class="language-json">DB_HOST='localhost'<br>DB_USER=postgres<br>DB_NAME=&lt;YOUR_CUSTOM_DATABASE_NAME_HERE><br>DB_PASSWORD=&lt;YOUR_MASTER_PASSWORD><br>DB_PORT=<span class="token number">5432</span></code></pre>
</li>
<li>
<p>Then we will <a href="https://node-postgres.com/features/connecting">connect</a> a new client through a <a href="https://node-postgres.com/features/pooling">connection pool</a> to our Postgresql database from our Nodejs. I do it in <code>server/db/index.js</code>:</p>
<p><a href="#db-wrapper" id="db-wrapper">#</a></p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span> Pool <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"pg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> pool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Pool</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  user<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB_USER</span><span class="token punctuation">,</span><br>  host<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB_HOST</span><span class="token punctuation">,</span><br>  port<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB_PORT</span><span class="token punctuation">,</span><br>  database<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB_NAME</span><span class="token punctuation">,</span><br>  password<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB_PASSWORD</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// TRANSACTION</span><br><span class="token comment">// https://github.com/brianc/node-postgres/issues/1252#issuecomment-293899088</span><br><span class="token keyword">const</span> <span class="token function-variable function">tx</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> errCallback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">await</span> pool<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">try</span> <span class="token punctuation">{</span><br>    <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"BEGIN"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">await</span> <span class="token function">callback</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"COMMIT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"DB ERROR:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"ROLLBACK"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    errCallback <span class="token operator">&amp;&amp;</span> <span class="token function">errCallback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span><br>    client<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token comment">// the pool will emit an error on behalf of any idle clients</span><br><span class="token comment">// it contains if a backend error or network partition happens</span><br>pool<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>pool<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"connect"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"‚ù§Ô∏è Connected to the Database ‚ù§Ô∏è"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><br>  <span class="token function-variable function">query</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">text<span class="token punctuation">,</span> params<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> pool<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> params<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">,</span><br>  tx<span class="token punctuation">,</span><br>  pool<span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<ul>
<li>I will use the <code>tx</code> function in an API if I have to call <strong>many</strong> queries that depends on each other.</li>
<li>If I'm making a <strong>single</strong> query, I will use the <code>query</code> function.</li>
</ul>
</li>
</ol>
<p>And that's it! Now you got a database to work with for your local development üöÄ</p>
<h4>Usage</h4>
<p>I will confess: I <strong>hand-craft</strong> all the queries for Sametable.</p>
<p>In my opinion, SQL itself is already a declarative language that needs no further abstraction‚Äîit's easy to read, understand, and write. It can be maintainable if you separated well your API endpoints. But, if you knew you were building a facebook-scale app, perhaps it would be wise to use an ORM. But I'm just a <a href="https://www.youtube.com/watch?v=5PsnxDQvQpw">everyday normal guy</a> building a very narrow-scoped SaaS all by myself. So I needed to avoid overhead and complexity while considering factors such as ease of onboarding, performance, ease of reiteration, and the potential lifespan of the knowledge. It reminds me of the advice urges us to learn vanilla Javascript before jumping on the bandwagon of a popular front-end framework. Because you just might realize: That's all you need for what you have set out to accomplish to reach your 1000th customer.</p>
<p>To be fair though, when I decided to go down this path, I'd had modest experiences in writing MySQL. So if you knew nothing about SQL and you were anxious to ship it, then you might want to consider a library like <a href="http://knexjs.org/">knex.js</a>.</p>
<h5>Example</h5>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// server/routes/projects.js</span><br><br><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"express"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> asyncHandler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"express-async-handler"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"../db"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span><br><br><span class="token comment">// [POST] api/projects/create</span><br>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><br>  <span class="token string">"/create"</span><span class="token punctuation">,</span><br>  express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> <span class="token punctuation">{</span> title<span class="token punctuation">,</span> project_id <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span><br><br>    db<span class="token punctuation">.</span><span class="token function">tx</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      <span class="token keyword">const</span> <span class="token punctuation">{</span><br>        rows<span class="token punctuation">,</span><br>      <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><br>        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">INSERT INTO tasks (title) VALUES ($1) RETURNING mask_id(task_id) as masked_task_id, task_id</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span><br>        <span class="token punctuation">[</span>title<span class="token punctuation">]</span><br>      <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>      res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> rows<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>masked_task_id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<ul>
<li>The <a href="https://github.com/Abazhenov/express-async-handler/blob/master/index.js"><code>express-async-handler</code></a> is mainly used to handle the async errors in my route handlers. It won't be needed anymore when Express 5 drops.</li>
</ul>
<ul>
<li>Import the <code>db</code> module to use the <code>tx</code> method. Pass your hand-crafted SQL queries and <a href="https://node-postgres.com/features/queries">parameters</a>.</li>
</ul>
<p>That's it!</p>
<h3>Creating table schemas <a href="#creating-table-schemas" id="creating-table-schemas">#</a></h3>
<p>Before you can start querying a database, you need to create tables. Each table contains information about an entity. But we don't just lump all information about an entity in the same table. We need to organize the information in a way that promotes query performance and data maintainability. And what has helped me in that exercise is a concept called <a href="https://firebase.google.com/docs/database/web/structure-data"><strong>denormalization</strong></a>. As mentioned, we don't want to store everything about an entity in the same table. For example, say, we have a <code>users</code> table storing <code>fullname</code>, <code>password</code> and <code>email</code>. That's fine so far. But problem arises when we are also storing the ids of all the projects assigned to a particular user in a separate column in the same table. Instead, I would break them up into separate tables:</p>
<ol>
<li>
<p>Create the <code>users</code> table. Notice that it's not storing any data related to 'projects':</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> users<span class="token punctuation">(</span><br>  user_id BIGSERIAL <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span><br>  fullname <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span><br>  pwd <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span><br>  email <span class="token keyword">TEXT</span> <span class="token keyword">UNIQUE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</li>
<li>
<p>Create a <code>projects</code> table to store data solely about a project's details:</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> projects<span class="token punctuation">(</span><br>  project_id BIGSERIAL <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span><br>  title <span class="token keyword">TEXT</span><span class="token punctuation">,</span><br>  content <span class="token keyword">TEXT</span><span class="token punctuation">,</span><br>  due_date TIMESTAMPTZ<span class="token punctuation">,</span><br>  <span class="token keyword">status</span> <span class="token keyword">SMALLINT</span><span class="token punctuation">,</span><br>  created_on TIMESTAMPTZ <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</li>
<li>
<p>Create a 'bridge' table about projects' ownerships by associating the ID of an user with the ID of a project that she owns:</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> project_ownerships<span class="token punctuation">(</span><br>  project_id <span class="token keyword">BIGINT</span> <span class="token keyword">REFERENCES</span> projects <span class="token keyword">ON</span> <span class="token keyword">DELETE</span> <span class="token keyword">CASCADE</span><span class="token punctuation">,</span><br>  user_id <span class="token keyword">BIGINT</span> <span class="token keyword">REFERENCES</span> users <span class="token keyword">ON</span> <span class="token keyword">DELETE</span> <span class="token keyword">CASCADE</span><span class="token punctuation">,</span><br>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>project_id<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token keyword">CONSTRAINT</span> project_user_unique <span class="token keyword">UNIQUE</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> project_id<span class="token punctuation">)</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</li>
<li>
<p>Finally, to get all the projects that are assigned to a particular user, we will do what relational database do best: <a href="https://www.postgresqltutorial.com/postgresql-joins/"><code>join</code></a>.</p>
</li>
</ol>
<p>I would put all my schemas in a <code>.sql</code> file at my project's root:</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> EXTENSION <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token string">"uuid-ossp"</span><span class="token punctuation">;</span><br><br><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> users<span class="token punctuation">(</span><br>  user_id BIGSERIAL <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span><br>  fullname <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span><br>  pwd <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span><br>  email <span class="token keyword">TEXT</span> <span class="token keyword">UNIQUE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span><br>  created_on TIMESTAMPTZ <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Then, I would copy, paste, and run them in pgAdmin:</p>
<img src="https://i.imgur.com/gm9YFZF.png" alt="create table schemas in pgadmin" loading="lazy" />
<p>No doubt there are more advanced ways of doing this, so it's up to you if you want to explore what you like.</p>
<h3>Dropping a database <a href="#dropping-a-database" id="dropping-a-database">#</a></h3>
<p>Deleting an entire database to start with a new set of schemas was something I had to do very often at the beginning.</p>
<p>The trick is: Well, you copy, paste, and run the command below in the database's query editor in pgAdmin:</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">SCHEMA</span> <span class="token keyword">public</span> <span class="token keyword">CASCADE</span><span class="token punctuation">;</span><br><span class="token keyword">CREATE</span> <span class="token keyword">SCHEMA</span> <span class="token keyword">public</span><span class="token punctuation">;</span><br><span class="token keyword">GRANT</span> <span class="token keyword">ALL</span> <span class="token keyword">ON</span> <span class="token keyword">SCHEMA</span> <span class="token keyword">public</span> <span class="token keyword">TO</span> postgres<span class="token punctuation">;</span><br><span class="token keyword">GRANT</span> <span class="token keyword">ALL</span> <span class="token keyword">ON</span> <span class="token keyword">SCHEMA</span> <span class="token keyword">public</span> <span class="token keyword">TO</span> <span class="token keyword">public</span><span class="token punctuation">;</span><br><span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">SCHEMA</span> <span class="token keyword">public</span> <span class="token operator">IS</span> <span class="token string">'standard public schema'</span><span class="token punctuation">;</span></code></pre>
<h3>Crafting SQL queries <a href="#crafting-sql-queries" id="crafting-sql-queries">#</a></h3>
<p>I write my SQL queries in <strong>pgAdmin</strong> to get the data I want out of an API endpoint.</p>
<p>To give a sense of direction to doing that in pgAdmin:
<img src="https://i.imgur.com/54tIRzc.png" alt="writing sql queries in pgadmin editor" loading="lazy" /></p>
<h4>Common Table Expressions(CTEs) <a href="#common-table-expressions" id="common-table-expressions">#</a></h4>
<p>I stumbled upon a pattern called <a href="https://www.postgresql.org/docs/9.1/queries-with.html"><strong>CTEs</strong></a> when I was exploring how I am going to get the data I want from disparate tables, and structure them as desired, without doing lots of separate database queries and for-loops.</p>
<p>The way CTE works is simple enough: You write your queries. Each query is given an alias name (<code>q</code>, <code>q1</code>, <code>q3</code>). And a next query can access any previous query's results by their alias name(<code>q1.workspace_id</code>):</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">WITH</span> q <span class="token keyword">AS</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> projects_tasks <span class="token keyword">WHERE</span> task_id<span class="token operator">=</span>$<span class="token number">1</span><span class="token punctuation">)</span><br><span class="token punctuation">,</span> q1 <span class="token keyword">AS</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> wp<span class="token punctuation">.</span>workspace_id<span class="token punctuation">,</span> wp<span class="token punctuation">.</span>project_id<span class="token punctuation">,</span> q<span class="token punctuation">.</span>task_id <span class="token keyword">FROM</span> workspaces_projects wp<span class="token punctuation">,</span> q <span class="token keyword">WHERE</span> wp<span class="token punctuation">.</span>project_id <span class="token operator">=</span> q<span class="token punctuation">.</span>project_id<span class="token punctuation">)</span><br><span class="token punctuation">,</span> q3 <span class="token keyword">AS</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> q1<span class="token punctuation">.</span>workspace_id <span class="token keyword">AS</span> workspace_id<span class="token punctuation">,</span> wp<span class="token punctuation">.</span>name <span class="token keyword">AS</span> workspace_title<span class="token punctuation">,</span> mask_id<span class="token punctuation">(</span>q1<span class="token punctuation">.</span>project_id<span class="token punctuation">)</span> <span class="token keyword">AS</span> project_id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>title <span class="token keyword">AS</span> project_title<span class="token punctuation">,</span> mask_id<span class="token punctuation">(</span>t<span class="token punctuation">.</span>task_id<span class="token punctuation">)</span> <span class="token keyword">AS</span> task_id<span class="token punctuation">,</span> t<span class="token punctuation">.</span>title<span class="token punctuation">,</span> t<span class="token punctuation">.</span>content<span class="token punctuation">,</span> t<span class="token punctuation">.</span>due_date<span class="token punctuation">,</span> t<span class="token punctuation">.</span>priority<span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token keyword">status</span><span class="token punctuation">)</span><br><br><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> q3<span class="token punctuation">;</span></code></pre>
<p>Almost all the queries in Sametable are written this way.</p>
<h3>Redis <a href="#redis" id="redis">#</a></h3>
<p>Redis is a NoSQL database that stores data in memory. In Sametable, I used Redis for two purposes:</p>
<ol>
<li>Store a user's session data and basic info from the <code>users</code> table‚Äîname, email, and a flag that indicates the user is a subscriber or not‚Äîonce they have logged in.</li>
<li>Cache the results of some of my Postgresql's queries to avoid having to query the database if the cache is still fresh.</li>
</ol>
<h4>Installation</h4>
<p>I'm on a Windows 10 machine with Windows Subsystem Linux(WSL) installed. This was the only guide I followed to install Redis on my machine:</p>
<p><a href="https://redislabs.com/blog/redis-on-windows-10/">https://redislabs.com/blog/redis-on-windows-10/</a></p>
<p>Follow the guide to install WSL if you don't have it already.</p>
<p>Then I will start my local Redis server in WSL bash:</p>
<ol>
<li>Press <code>Win</code> + <code>R</code>.</li>
<li>Type <code>bash</code> and enter.</li>
<li>In the terminal, run <code>sudo service redis-server start</code></li>
</ol>
<p>Now install the <a href="https://www.npmjs.com/package/redis"><code>redis</code></a> npm package:</p>
<pre class="language-json"><code class="language-json">cd server<br><br>npm i redis</code></pre>
<p>Make sure to install it in the <code>server</code>'s <code>package.json</code>, hence the <code>cd server</code>.</p>
<p>Then I create a file named <code>redis.js</code> under <code>server/db</code>:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// server/db/redis.js</span><br><br><span class="token keyword">const</span> redis <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"redis"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> <span class="token punctuation">{</span> promisify <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"util"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> redisClient <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">createClient</span><span class="token punctuation">(</span><br>  <span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">"production"</span><br>    <span class="token operator">?</span> <span class="token punctuation">{</span><br>        host<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REDISHOST</span><span class="token punctuation">,</span><br>        no_ready_check<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>        auth_pass<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REDIS_PASSWORD</span><span class="token punctuation">,</span><br>      <span class="token punctuation">}</span><br>    <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>redisClient<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"ERR:REDIS:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> redisGetAsync <span class="token operator">=</span> <span class="token function">promisify</span><span class="token punctuation">(</span>redisClient<span class="token punctuation">.</span>get<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>redisClient<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> redisSetExAsync <span class="token operator">=</span> <span class="token function">promisify</span><span class="token punctuation">(</span>redisClient<span class="token punctuation">.</span>setex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>redisClient<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> redisDelAsync <span class="token operator">=</span> <span class="token function">promisify</span><span class="token punctuation">(</span>redisClient<span class="token punctuation">.</span>del<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>redisClient<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// 1 day expiry</span><br><span class="token keyword">const</span> <span class="token constant">REDIS_EXPIRATION</span> <span class="token operator">=</span> <span class="token number">7</span> <span class="token operator">*</span> <span class="token number">86400</span><span class="token punctuation">;</span> <span class="token comment">// seconds</span><br><br>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><br>  redisGetAsync<span class="token punctuation">,</span><br>  redisSetExAsync<span class="token punctuation">,</span><br>  redisDelAsync<span class="token punctuation">,</span><br>  <span class="token constant">REDIS_EXPIRATION</span><span class="token punctuation">,</span><br>  redisClient<span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<ul>
<li>
<p>By <a href="https://www.npmjs.com/package/redis#options-object-properties">default</a>, <code>node-redis</code> will connect to <code>localhost</code> at port <code>6379</code>. But that might not be the case in production if you host your Redis in a VM. So I provide this object if it's in production mode:</p>
<pre class="language-js"><code class="language-js"><span class="token punctuation">{</span><br>   host<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REDISHOST</span><span class="token punctuation">,</span><br>   no_ready_check<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>   auth_pass<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REDIS_PASSWORD</span><span class="token punctuation">,</span><br> <span class="token punctuation">}</span></code></pre>
<ul>
<li>TBH, I'm not entirely sure about the <code>no_ready_check</code>. I got it from this official <a href="https://docs.redislabs.com/latest/rs/references/client_references/client_nodejs/">tutorial</a>.</li>
<li>The <code>auth_pass</code> and <code>host</code> are provided as custom since I host my Redis in a GCE VM where I have set a password on my Redis.</li>
</ul>
</li>
</ul>
<ul>
<li>I <a href="https://www.npmjs.com/package/redis#promises">promisfy</a> the Redis methods that I will use to make them async to avoid blocking NodeJS's single-thread.</li>
</ul>
<p>And now you have the Redis for your local development!</p>
<h3>Error handling &amp; Logging <a href="#error-handling-and-logging" id="error-handling-and-logging">#</a></h3>
<h4>Error handling</h4>
<p>Error handling in Nodejs has a paradigm which we will explore in 3 different contexts.</p>
<p>To set the stage, we need two things in place first:</p>
<ol>
<li>
<p>An npm package called <a href="https://www.npmjs.com/package/http-errors">http-errors</a> that will give us a standard error data structure to work with especially in client-side.</p>
<pre class="language-json"><code class="language-json">npm install http-errors</code></pre>
</li>
<li>
<p>We create a custom error handler at the global level to capture <strong>all</strong> propagated errors from the routes or the <code>catch</code> blocks via <code>next(err)</code>:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// app.js</span><br><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"express"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> createError <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"http-errors"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// our central custom error handler</span><br><span class="token comment">// NOTE: DON"T REMOVE THE 'next' even though eslint complains it's not being used!!!</span><br>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// errors wrapped by http-errors will have 'status' property defined. Otherwise, it's a generic unexpected error</span><br>  <span class="token keyword">const</span> error <span class="token operator">=</span> err<span class="token punctuation">.</span>status<br>    <span class="token operator">?</span> err<br>    <span class="token operator">:</span> <span class="token function">createError</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">"Something went wrong. Notified dev."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>As you will see, the general pattern of error handling in Nodejs revolves around the 'middleware' chain and the <code>next</code> parameter:</p>
<blockquote>
<p>Calls to next() and next(err) indicate that the current handler is complete and in what state. next(err) will skip all remaining handlers in the chain except for those that are set up to handle errors . . . <a href="https://expressjs.com/en/guide/error-handling.html">source</a></p>
</blockquote>
<p>Note that although this is a common pattern of handling error in Express, you might want to consider an <a href="https://github.com/goldbergyoni/nodebestpractices/blob/master/sections/errorhandling/centralizedhandling.md">alternative way</a> that's, however, more complicated.</p>
</li>
</ol>
<h5>Handle input validation errors</h5>
<p>It's a <a href="https://github.com/goldbergyoni/nodebestpractices#-610-validate-incoming-json-schemas">good practise</a> to validate a user's inputs both in the client and server-side. At the server-side, I use a library called <a href="https://express-validator.github.io/docs/">'express-validator'</a> to do the job. If any input is invalid, I will handle it by responding with an HTTP code and an error message to inform the user about it.</p>
<p>For example, when an email provided by a user is invalid, we will exit early by creating an error object with the 'http-errors' library, and then pass it to the <code>next</code> function:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span> body<span class="token punctuation">,</span> validationResult <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"express-validator"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><br>  <span class="token string">"/login"</span><span class="token punctuation">,</span><br>  upload<span class="token punctuation">.</span><span class="token function">none</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token punctuation">[</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">"email"</span><span class="token punctuation">,</span> <span class="token string">"Invalid email format"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token function">validationResult</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>errors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token function">createError</span><span class="token punctuation">(</span><span class="token number">422</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">mapped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>The following response will be sent to the client:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>  <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"Unprocessable Entity"</span><span class="token punctuation">,</span><br>  <span class="token property">"email"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"hello@mail.com232"</span><span class="token punctuation">,</span><br>    <span class="token property">"msg"</span><span class="token operator">:</span> <span class="token string">"Invalid email format"</span><span class="token punctuation">,</span><br>    <span class="token property">"param"</span><span class="token operator">:</span> <span class="token string">"email"</span><span class="token punctuation">,</span><br>    <span class="token property">"location"</span><span class="token operator">:</span> <span class="token string">"body"</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>Then it's up to you what you want to do with it. For example, you can access the <code>email.msg</code> property to display the error message below the email input field.</p>
<h5>Handle errors from business logic</h5>
<p>Let's say we have a situation where a user entered an email that didn't exist in the database. In that case, we need to tell the user to try again:</p>
<pre class="language-javascript"><code class="language-javascript">router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><br>  <span class="token string">"/login"</span><span class="token punctuation">,</span><br>  upload<span class="token punctuation">.</span><span class="token function">none</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> <span class="token punctuation">{</span> email<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span><br><br>    <span class="token keyword">const</span> <span class="token punctuation">{</span><br>      rowCount<span class="token punctuation">,</span><br>    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT * FROM users WHERE email=($1)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">[</span>email<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>rowCount <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token comment">// issue an error with generic message</span><br>      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><br>        <span class="token function">createError</span><span class="token punctuation">(</span><span class="token number">422</span><span class="token punctuation">,</span> <span class="token string">"Please enter a correct email and password"</span><span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Remember, any error object passed to 'next'(<code>next(err)</code>) will be captured by the custom error handler that we have set above.</p>
<h5>Handle unexpected errors from database</h5>
<p>I pass the route handler's <code>next</code> to my db's <a href="#db-wrapper">transaction</a> wrapper function to handle any unexpected erorrs.</p>
<pre class="language-javascript"><code class="language-javascript">router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><br>  <span class="token string">"/invite"</span><span class="token punctuation">,</span><br>  <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    db<span class="token punctuation">.</span><span class="token function">tx</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>          <span class="token keyword">const</span> <span class="token punctuation">{</span><br>            rows<span class="token punctuation">,</span><br>            rowCount<span class="token punctuation">,</span><br>          <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><br>            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT mask_id(user_id) AS user_id, status FROM users WHERE users.email=$1</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span><br>            <span class="token punctuation">[</span>email<span class="token punctuation">]</span><br>          <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span> next<span class="token punctuation">)</span><br><span class="token punctuation">)</span></code></pre>
<h4>Logging</h4>
<p>When an error occurred, it's a common practice to 1) Log it to a system for records, and 2) Automatically notify you about it.</p>
<p>There are many tools out there in this area. But I ended up with two of them:</p>
<ul>
<li><a href="https://sentry.io/welcome/"><strong>Sentry</strong></a> for storing details(e.g. stack traces) of my errors, and display them on their web-based dashboard.</li>
<li><a href="https://github.com/pinojs/pino"><strong>pino</strong></a> to enable logging in my Nodejs.</li>
</ul>
<p><strong>Why Sentry</strong>? Well, it was recommended by lots of devs and small startups. It offers 5000 errors you can send per month for free. For perspective, if you are operating a small side project and careful about it, I would say that'd last you until you can afford a more luxurious vendor or plan. Another option worth exploring is <a href="https://www.honeybadger.io/">honeybadger.io</a> with more generous free-tier but without a <a href="https://getpino.io/#/docs/transports">pino transport</a>.</p>
<p><strong>Why Pino</strong>- Why not the official SDK provided by Sentry? Because Pino has <a href="https://github.com/pinojs/pino#low-overhead">'low overhead'</a>, whereas, Sentry SDK, although it gives you a more complete picture of an error, seemed to have a complex <a href="https://github.com/getsentry/sentry-javascript/issues/1762">memory issue</a> that I couldn't see myself being able to circumvent.</p>
<p>With that, here is how logging system is hooked up in Sametable:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// server/lib/logger.js</span><br><br><span class="token comment">// install missing packages</span><br><span class="token keyword">const</span> pino <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"pino"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> <span class="token punctuation">{</span> createWriteStream <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"pino-sentry"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> expressPino <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"express-pino-logger"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"sametable"</span><span class="token punctuation">,</span> level<span class="token operator">:</span> <span class="token string">"error"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token comment">// SENTRY_DSN is provided by Sentry. Store it as env var in the .env file.</span><br><span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dsn<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SENTRY_DSN</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">pino</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> expressLogger <span class="token operator">=</span> <span class="token function">expressPino</span><span class="token punctuation">(</span><span class="token punctuation">{</span> logger <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><br>  expressLogger<span class="token punctuation">,</span> <span class="token comment">// use it like app.use(expressLogger) -> req.log.info('haha)</span><br>  logger<span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>Rather than attaching the logger(<code>expressLogger</code>) as a middleware at the top of the chain(<code>app.use(expressLogger)</code>), I use the <code>logger</code> object only where I want to log an error.</p>
<p>For example, the custom global error handler uses the <code>logger</code> object:</p>
<pre class="language-javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> error <span class="token operator">=</span> err<span class="token punctuation">.</span>status<br>    <span class="token operator">?</span> err<br>    <span class="token operator">:</span> <span class="token function">createError</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">"Something went wrong. Notified dev."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>isProduction<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// LOG THIS ERROR IN MY SENTRY DASHBOARD</span><br>    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Custom error handler:"</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>That's it! And don't forget to enable email <strong>notification</strong> in your Sentry dashboard to get an alert when your Sentry receives an error! ‚ù§Ô∏è</p>
<h2>User Authentication System <a href="#user-authentication-system" id="user-authentication-system">#</a></h2>
<p>A user authentication system can get very complicated if you need to support things like SSO and third-party OAuth providers. That's why we have third-party tools such as Auth0, Okta, and PassportJS to abstract that out for us. But those tools cost: vendor lock-in, more Javascript payload, and cognitive overhead.</p>
<p>I would argue that if you are starting out and just need <em>some</em> <em>kind of</em> authentication system so you can move on to other parts of your app, and at the same time, overwhelmed by all the dated tutorials that deal with stuff you don't use, well, chances are all you need is the good old way of doing authentication: <strong>Session cookie</strong> with <strong>email</strong> and <strong>password</strong>! And we are not talking about 'JWT' either! None of that.</p>
<h3>Guide <a href="#user-authentication-system-guide" id="user-authentication-system-guide">#</a></h3>
<p><a href="https://medium.com/@kilgarenone/easily-implements-user-authentication-in-nodejs-b22bdb6f15bc">Here is a guide</a> I ended up writing. Follow it and you got yourself a user authentication system!</p>
<h2>Email <a href="#email" id="email">#</a></h2>
<p>Currently, in Sametable, the only emails it sends are of 'transactional' type like sending a reset password email when users reset their password.</p>
<p>There are two ways to send emails in Nodejs:</p>
<ol>
<li>
<p><strong>Roll your own</strong> with <a href="https://nodemailer.com/about/">Nodemailer</a>.</p>
<p>I wouldn't go down this path because although sending one email might seem a trivial task, doing it 'at scale' is hard; every email must be sent successfully; and they must not end up in a user's spam folder; and other things I'm not aware of.</p>
</li>
<li>
<p>Choose one of the <strong>email service providers</strong>.</p>
<p>Many email services offer a free-tier plan offering a limited number of emails you can send per month/day for free. When I started exploring this space for Sametable in October 2019, Mailgun stood out to be a no-brainer‚ÄîIt offers 10,000 emails for free per month! But, sadly, as I was researching for this section write-up, I learned that it no longer offers that. Despite that, though, I would still stick to Mailgun, on their <a href="https://www.mailgun.com/pricing">pay-as-you-go</a> plan: 1000 emails sent will cost you 80 cents.</p>
<p>If you would rather not pay a cent for whatever reason, here are two options for you that I could find:</p>
<ul>
<li><a href="https://www.mailjet.com/pricing/">https://www.mailjet.com/pricing/</a></li>
<li><a href="https://www.sendinblue.com/pricing/">https://www.sendinblue.com/pricing/</a></li>
</ul>
<p>But do go down this path while being aware there's no guarantee that these free-tier plans will stay that way forever as was the case with Mailgun.</p>
</li>
</ol>
<h3>Implementation <a href="#implement-email" id="implement-email">#</a></h3>
<h4>Wrapper file</h4>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// server/lib/email.js</span><br><br><span class="token comment">// Run 'npm install mailgun-js' in your 'server' folder</span><br><span class="token keyword">const</span> mailgun <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"mailgun-js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token constant">DOMAIN</span> <span class="token operator">=</span> <span class="token string">"mail.sametable.app"</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> mg <span class="token operator">=</span> <span class="token function">mailgun</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  apiKey<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MAILGUN_API_KEY</span><span class="token punctuation">,</span><br>  domain<span class="token operator">:</span> <span class="token constant">DOMAIN</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">function</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  mg<span class="token punctuation">.</span><span class="token function">messages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Email send error:"</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><br>  send<span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<h4>Usage</h4>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> mailer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"../lib/email"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// Simplified for only email-related stuff</span><br>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><br>  <span class="token string">"/resetPassword"</span><span class="token punctuation">,</span><br>  upload<span class="token punctuation">.</span><span class="token function">none</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> <span class="token punctuation">{</span> email <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span><br>    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span><br>      <span class="token keyword">from</span><span class="token operator">:</span> <span class="token string">"Sametable &lt;feedback@sametable.app>"</span><span class="token punctuation">,</span><br>      to<span class="token operator">:</span> email<span class="token punctuation">,</span><br>      subject<span class="token operator">:</span> <span class="token string">"Reset your password"</span><span class="token punctuation">,</span><br>      text<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Click this link to reset your password: https://example.com?token=1234</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">;</span><br>    mailer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h3>Email templates <a href="#email-templates" id="email-templates">#</a></h3>
<p>Each type of email you send could have its own email template whose content can be varied with dynamic values you can provide.</p>
<h4>Tool</h4>
<p><a href="https://mjml.io/"><strong>mjml</strong></a> is the tool I use to build my email templates.</p>
<p>It's easy to <a href="https://mjml.io/getting-started/1">get started</a>. It's quite similar to React: You compose a template with a bunch of reusable components with props.</p>
<p>Here are the places where I would write my templates:</p>
<ul>
<li>This <a href="https://marketplace.visualstudio.com/items?itemName=attilabuti.vscode-mjml">VSCode extension</a></li>
<li><a href="https://mjml.io/try-it-live">Live code editor</a></li>
</ul>
<h4>Example template</h4>
<details>
  <summary>Email Template</summary>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mjml</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mj-head</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mj-attributes</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mj-class</span><br>        <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>font-family<span class="token punctuation">"</span></span><br>        <span class="token attr-name">font-family</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>-apple-system,system-ui,BlinkMacSystemFont,'Segoe UI',sans-serif<span class="token punctuation">"</span></span><br>      <span class="token punctuation">/></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mj-class</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fw-600<span class="token punctuation">"</span></span> <span class="token attr-name">font-weight</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>600<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mj-attributes</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mj-head</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mj-body</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mj-section</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mj-column</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mj-image</span><br>          <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>150px<span class="token punctuation">"</span></span><br>          <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://www.dl.dropboxusercontent.com/s/pgtwrnfa3lqkf5r/sametable_logo_with_text.png<span class="token punctuation">"</span></span><br>        <span class="token punctuation">/></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mj-column</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mj-section</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mj-section</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mj-column</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mj-text</span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>center<span class="token punctuation">"</span></span> <span class="token attr-name">font-size</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>20px<span class="token punctuation">"</span></span> <span class="token attr-name">mj-class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>font-family<span class="token punctuation">"</span></span><br>          <span class="token punctuation">></span></span> assigned a project to you<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mj-text</span><br>        <span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mj-spacer</span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10px<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mj-text</span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>center<span class="token punctuation">"</span></span> <span class="token attr-name">font-size</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>25px<span class="token punctuation">"</span></span> <span class="token attr-name">mj-class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>font-family fw-600<span class="token punctuation">"</span></span><br>          <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mj-text</span><br>        <span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mj-spacer</span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>25px<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mj-button</span><br>          <span class="token attr-name">font-size</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>16px<span class="token punctuation">"</span></span><br>          <span class="token attr-name">mj-class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>font-family fw-600<span class="token punctuation">"</span></span><br>          <span class="token attr-name">background-color</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#000<span class="token punctuation">"</span></span><br>          <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>white<span class="token punctuation">"</span></span><br>          <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><br>          <span class="token punctuation">></span></span>View the project<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mj-button</span><br>        <span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mj-column</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mj-section</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mj-spacer</span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>55px<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mj-section</span> <span class="token attr-name">background-color</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#EEEBE7<span class="token punctuation">"</span></span> <span class="token attr-name">padding</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>25px 40px<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mj-column</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mj-text</span><br>          <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>center<span class="token punctuation">"</span></span><br>          <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#45495d<span class="token punctuation">"</span></span><br>          <span class="token attr-name">font-size</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>15px<span class="token punctuation">"</span></span><br>          <span class="token attr-name">line-height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>14px<span class="token punctuation">"</span></span><br>        <span class="token punctuation">></span></span><br>          Problems or questions? Feel free to reply to this email.<br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mj-text</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mj-text</span> <span class="token attr-name">padding</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>30px 0 0 0<span class="token punctuation">"</span></span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>center<span class="token punctuation">"</span></span> <span class="token attr-name">font-size</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>16px<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>          Made with ‚ù§Ô∏è by<br>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://twitter.com/kheohyeewei<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>@kheohyeewei<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mj-text</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mj-column</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mj-section</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mj-body</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mjml</span><span class="token punctuation">></span></span></code></pre>
</details>
<h5>Result</h5>
<img width="400px" src="https://i.imgur.com/JnaSDYJ.png" loading="lazy" />
<p>Notice the placeholder names that are wrapped in double curly brackets such as ``. They will be replaced with their corresponding value by, in my case, Mailgun, before sent out.</p>
<h4>Integration with Mailgun</h4>
<p>First, generate HTML from your mjml templates. You are able to do that with the VSCode extension or the web-based editor:</p>
<img src="https://i.imgur.com/O9mnBvN.png" alt="generate html in mjml online code editor" loading="lazy" />
<p>Then create a new template on your Mailgun dashboard:</p>
<img src="https://i.imgur.com/OkvLxiT.png" alt="create message template on mailgun dashboard" loading="lazy" />
<h4>Send an email with Mailgun in Nodejs</h4>
<p>Inside a route:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span><br>  <span class="token keyword">from</span><span class="token operator">:</span> <span class="token string">"Sametable &lt;feedback@sametable.app>"</span><span class="token punctuation">,</span><br>  to<span class="token operator">:</span> email<span class="token punctuation">,</span><br>  subject<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Hello</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span><br>  template<span class="token operator">:</span> <span class="token string">"invite_project"</span><span class="token punctuation">,</span> <span class="token comment">// the template's name you gave when you created it in mailgun</span><br>  <span class="token string">"v:invite_link"</span><span class="token operator">:</span> inviteLink<span class="token punctuation">,</span><br>  <span class="token string">"v:assigner_name"</span><span class="token operator">:</span> fullname<span class="token punctuation">,</span><br>  <span class="token string">"v:project_title"</span><span class="token operator">:</span> title<span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>mailer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Notice that, to associate a value with a placeholder name in a template: <code>&quot;v:project_title&quot;:'Project Mario'</code>.</p>
<h2>Tenancy <a href="#tenancy" id="tenancy">#</a></h2>
<p>When an organization, say, Acme Inc., signs up on your SaaS, it's considered a 'tenant' ‚Äî They 'occupy' a spot on your service.</p>
<p>While I'd heard of the 'multi-tenancy' term being associated with a SaaS before, I never had the slightest idea about implementing it. I always thought that it'd involve some cryptic computer-sciency maneuvering that I couldn't possibly have figured it all out by myself.</p>
<p>Fortunately, there is an easy way to do 'multi-tenancy':</p>
<blockquote>
<p>Single database; all clients share the same tables; each client has a <code>tenant_id</code>; queries the database as per an API request by <code>WHERE tenant_id = $ID</code>.</p>
</blockquote>
<p>So don't worry‚ÄîIf you know basic SQL, you should have a clear picture on the steps required to implement this.</p>
<p>Here are three instrumental resources about 'multi-tenancy' I bookmarked before:</p>
<ul>
<li><a href="https://stackoverflow.com/a/47783180/73323">https://stackoverflow.com/a/47783180/73323</a></li>
<li><a href="https://stackoverflow.com/a/44530588/73323">https://stackoverflow.com/a/44530588/73323</a></li>
<li><a href="https://blog.checklyhq.com/building-a-multi-tenant-saas-data-model/">https://blog.checklyhq.com/building-a-multi-tenant-saas-data-model/</a></li>
</ul>
<h2>Domain name <a href="#domain-name" id="domain-name">#</a></h2>
<p>Sametable.app domain and all its DNS records are hosted in <a href="https://www.namecheap.com/"><strong>NameCheap</strong></a>. I was on <a href="https://www.hover.com/">hover</a> before(it still hosts my personal website's domain). But I hit a limitation there when I tried to enter my Mailgun's DKIM value. Namecheap also has more competitive prices in my experience.</p>
<p>At which stage in your SaaS development should you get a domain name? Well, I would say not until when the lack of a DNS registrar is blocking your development. In my case, I deferred it until I had to integrate Mailgun which requires creating a bunch of DNS records in a domain.</p>
<h2>Deployment <a href="#deployment" id="deployment">#</a></h2>
<p>Ugh. This was a stage where I struggled for the longest time üò£. It was one hell of a journey where I found myself doubling down on a cloud platform but end up bailing out as I found out their downsides to optimize for developer experience, costs, quota, and performance(latency).</p>
<p>The journey started with me jumping head-first(bad idea) into Digital Ocean since I saw it recommended a lot in the IndieHackers forum. And sure enough, I managed to get my Nodejs up and running in a VM by following <a href="https://coderrocketfuel.com/article/create-and-deploy-an-express-rest-api-to-a-digitalocean-server#configure-and-deploy-your-node-js-app">closely</a> the <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-node-js-application-for-production-on-ubuntu-18-04">tutorials</a>. Then I found out that the <a href="https://www.digitalocean.com/products/spaces/">DO Space</a> wasn't exactly AWS S3‚ÄîIt <a href="https://ideas.digitalocean.com/ideas/DO-I-318">can't</a> host my SPA. Although I <a href="https://coderrocketfuel.com/article/deploy-a-create-react-app-website-to-digitalocean">could have</a> hosted it in my droplet and <a href="https://www.youtube.com/watch?v=2X_Tp_G7aTs">hook up</a> a third-party CDN like CloudFlare to the droplet, it seemed to me unnecessarily convoluted compared to the S3+Cloudfront setup. I was also using a DO's Managed Database(Postgresql) because I didn't want to manage my DB and tweak in the <code>*.config</code> files myself. That costs a fixed $15/month.</p>
<p>Then I learned about <a href="https://aws.amazon.com/lightsail/">AWS Lightsail</a> which is a mirror image of DO, but to my surprise, with more competitive <a href="https://aws.amazon.com/lightsail/pricing/">quota</a> at a given price point:</p>
<p><strong>VM at $5/month</strong></p>
<table>
<thead>
<tr>
<th>AWS Lightsail</th>
<th>Digital Ocean</th>
</tr>
</thead>
<tbody>
<tr>
<td>1 GB Memory</td>
<td>1 GB Memory</td>
</tr>
<tr>
<td>1 Core Processor</td>
<td>1 Core Processor</td>
</tr>
<tr>
<td><strong>40 GB</strong> SSD Disk</td>
<td>25 GB SSD Disk</td>
</tr>
<tr>
<td><strong>2 TB</strong> transfer</td>
<td>1 TB transfer</td>
</tr>
</tbody>
</table>
<p><strong>Managed database at $15/month</strong></p>
<table>
<thead>
<tr>
<th>AWS Lightsail</th>
<th>Digital Ocean</th>
</tr>
</thead>
<tbody>
<tr>
<td>1 GB Memory</td>
<td>1 GB Memory</td>
</tr>
<tr>
<td>1 Core Processor</td>
<td>1 Core Processor</td>
</tr>
<tr>
<td><strong>40 GB</strong> SSD Disk</td>
<td>10 GB SSD Disk</td>
</tr>
</tbody>
</table>
<p>So I started betting on Lightsail instead. But, the $15/month for a managed database in Lightsail got to me at one point. I didn't want to have to pay that money when I wasn't even sure that I would ever have any paying customers.</p>
<p>At this point, I supposed that I had to get my hands dirty to optimize for the cost factor. So I started looking into wiring AWS EC2, RDS, etc. But there were just too many of AWS-specific things I had to pick up, and the AWS doc wasn't exactly helping either‚ÄîIt's one rabbit hole after another just to do one thing because I just needed something to host my SPA and Nodejs for goodness sake!</p>
<p>Then I checked back in IndieHacker for a sanity check, and came across <a href="https://render.com/">render.com</a>. It seemed perfect! It's one of those tools that are on a mission '<em>so you can focus on building your app</em>'. The tutorials were short and got you up and running in no time. And here is the '<em>but</em>'‚ÄîIt was <a href="https://render.com/pricing">expensive</a>:</p>
<p><strong>Comparison of Lightsail and Render at their lowest price point</strong></p>
<table>
<thead>
<tr>
<th>AWS Lightsail($3.50/mo)</th>
<th>Render($7/mo)</th>
</tr>
</thead>
<tbody>
<tr>
<td>512 GB Memory</td>
<td>512 MB Memory</td>
</tr>
<tr>
<td>1 Core Processor</td>
<td>Shared Processor</td>
</tr>
<tr>
<td>20 GB SSD Disk</td>
<td>$0.25/GB/mo SSD Disk(20GB = $5/mo)</td>
</tr>
<tr>
<td>1 TB transfer</td>
<td>100 GB/mo. $0.10/GB above that(1TB = $90/mo)</td>
</tr>
</tbody>
</table>
<p>And that's just for hosting my Nodejs!</p>
<p>So what now?! Do I just say <em>f*** it</em> and do whatever it takes to 'ship it'?</p>
<p>But I hold my ground. I revisit AWS again. I still believed AWS was the answer because everyone else is singing its song. I must be missing something! This time I considered their higher-level tools like AWS AppSync and Amplify. But I couldn't overlook the fact that both of them force me to completely work by their standards and library. So at this point, I'd had it with AWS, and turned to another...platform: <strong>Google Cloud Platform(GCP)</strong>.</p>
<p><strong>Sametable's Nodejs, Redis, and Postgresql are hosted on GCP</strong>. The thing that drew me to GCP was its documentation‚ÄîIt's much more linear; code snippets everywhere for your specific language; step-by-step guides about the common things you would do for a web app. Plus, it's serverless! Which means your cost is proportional to your usage.</p>
<h3>Deploy Nodejs <a href="#deploy-nodejs" id="deploy-nodejs">#</a></h3>
<p>The GAE <a href="https://cloud.google.com/appengine/docs/the-appengine-environments">'standard environment'</a> hosts my Nodejs.</p>
<h4>Cost</h4>
<p>GAE's standard environment has <a href="https://cloud.google.com/free/docs/gcp-free-tier#always-free-usage-limits">free quota</a> unlike the 'flexible environment'. Beyond that, you will pay only if somebody is using your SaaS üòä.</p>
<h4>Guide</h4>
<p>This was the <em>only</em> guide I relied on. It was my north star. It covers Nodejs, Postgresql, Redis, file storage, and more:</p>
<blockquote>
<p><a href="https://cloud.google.com/appengine/docs/standard/nodejs">https://cloud.google.com/appengine/docs/standard/nodejs</a></p>
</blockquote>
<p>Start with the <a href="https://cloud.google.com/appengine/docs/standard/nodejs/quickstart">'Quick Start'</a> tutorial because it will set you up with the <code>gcloud cli</code> which you are going to need when following the rest of the guides, where you will find commands you can run to follow along. If you aren't comfortable with CLI environment, the guides will provide alternative steps to achieve the same thing on the GCP dashboard. I love it.</p>
<p>I noticed that while going through the GCP doc, I never had to open more than 4 tabs in my browser. It was the complete opposite with AWS doc- My browser would be <em>packed</em> with it.</p>
<h3>Deploy Postgresql <a href="#deploy-psql" id="deploy-psql">#</a></h3>
<h4>Guide</h4>
<p><a href="https://cloud.google.com/sql/docs/postgres/connect-app-engine-standard">https://cloud.google.com/sql/docs/postgres/connect-app-engine-standard</a></p>
<p>Just follow it and you will be fine.</p>
<h4>Cost</h4>
<p>It's pay-as-you-use as opposed to the fixed $15/mo you find in Lightsail and DO.</p>
<p>Sample cost:
<a href="https://cloud.google.com/products/calculator/#id=dd6b78da-1215-4366-b7b4-afefe5472ee6">https://cloud.google.com/products/calculator/#id=dd6b78da-1215-4366-b7b4-afefe5472ee6</a></p>
<h3>Deploy Redis <a href="#deploy-redis" id="deploy-redis">#</a></h3>
<p>If you were following the main guide about Nodejs, you can't miss <a href="https://cloud.google.com/appengine/docs/standard/nodejs/using-memorystore">this guide</a> about setting up your Redis in MemoryStore. But I figured it would be more cost-effective to <strong>host my Redis in a Google Compute Engine</strong>(GCE) which has, unlike MemoryStore, free quota. (Also <a href="https://github.com/ripienaar/free-for-dev#major-cloud-providers">see this</a> for comparison of free quota across different cloud platforms)</p>
<h4>Guide</h4>
<ol>
<li><a href="https://cloud.google.com/community/tutorials/setting-up-redis">Setup</a> Redis in a VM.</li>
</ol>
<ol start="2">
<li>
<p><a href="https://cloud.google.com/appengine/docs/standard/python/connecting-vpc">Setup</a> VPC:</p>
<blockquote>
<p>Serverless VPC Access enables you to connect from your App Engine app directly to your VPC network, <strong>allowing access to Compute Engine VM instances</strong>, Memorystore instances, and any other resources with an internal IP address.</p>
</blockquote>
</li>
</ol>
<ol start="3">
<li>
<p>In your <code>app.yaml</code> file:</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">vpc_access_connector</span><span class="token punctuation">:</span><br>  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"&lt;YOURS_HERE>"</span><br><br><span class="token key atrule">env_variables</span><span class="token punctuation">:</span><br>  <span class="token key atrule">REDIS_PASSWORD</span><span class="token punctuation">:</span> <span class="token string">"&lt;PASSWORD_YOU_SET_IN_A_GUIDE_ABOVE>"</span><br>  <span class="token key atrule">REDISHOST</span><span class="token punctuation">:</span> <span class="token string">"&lt;INTERNAL_IP_OF_YOUR_VM>"</span><br>  <span class="token key atrule">REDISPORT</span><span class="token punctuation">:</span> <span class="token string">"6379"</span> <span class="token comment"># default port when install redis</span></code></pre>
<figure>
 <img src="https://i.imgur.com/N4bqhcT.png" alt="internal ip of a GCE vm" loading="lazy" />
 <figcaption>
     <small>Internal IP of a GCE</small>
 </figcaption>
</figure>
</li>
<li>
<p>Finally, in <code>lib/redis.js</code>:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> redis <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"redis"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> redisClient <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">createClient</span><span class="token punctuation">(</span><br>  <span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">"production"</span><br>    <span class="token operator">?</span> <span class="token punctuation">{</span><br>        host<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REDISHOST</span><span class="token punctuation">,</span><br>        port<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REDISPORT</span><span class="token punctuation">,</span> <span class="token comment">// default to 6379 if wasn't set</span><br>        no_ready_check<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>        auth_pass<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REDIS_PASSWORD</span><span class="token punctuation">,</span><br>      <span class="token punctuation">}</span><br>    <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// just use the default: localhost and ports</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><br>  redisClient<span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
</li>
</ol>
<h3>File Storage <a href="#deploy-file-storage" id="deploy-file-storage">#</a></h3>
<p><a href="https://cloud.google.com/storage/docs">Cloud Storage</a> is what you need for your users to upload their files such as images which they will need to retrieve and possibly display later.</p>
<h4>Cost</h4>
<p>There is a <a href="https://cloud.google.com/free/docs/gcp-free-tier#always-free-usage-limits">free tier</a> for Cloud Storage too.</p>
<h4>Guide</h4>
<ul>
<li>You will be fine:
<a href="https://cloud.google.com/appengine/docs/standard/nodejs/using-cloud-storage">https://cloud.google.com/appengine/docs/standard/nodejs/using-cloud-storage</a></li>
</ul>
<h2>Rich-text Editor <a href="#rte" id="rte">#</a></h2>
<p>Building the rich-text editor in Sametable was the second most challenging thing for me. Now, I realized that I could have had it easy with those drop-in editors such as CKEditor and TinyMCE, but I wanted to be able to craft the writing experience in the editor, and there was nothing better than <a href="https://prosemirror.net/"><strong>ProseMirror</strong></a> in that regard. Sure, I had other options too, which I decided against for several reasons:</p>
<ol>
<li><a href="https://quilljs.com/">Quilljs</a>
<ul>
<li>Seemed many unaddressed <a href="https://github.com/quilljs/quill/issues">issues</a>.</li>
<li>Shaped specifically by a special-interest group.</li>
<li>Involves hacky workaround once you ventured out from the set of standard use cases.</li>
</ul>
</li>
<li><a href="https://draftjs.org/">Draftjs</a>
<ul>
<li>It's for React. Sametable is on Preact.</li>
</ul>
</li>
<li><a href="https://trix-editor.org/">trix</a>
<ul>
<li>Based on Web Component. I had issues integrating it in Preact.</li>
<li>It wasn't flexible to build a customized editing experience.</li>
</ul>
</li>
</ol>
<p><strong>Prosemirror</strong> is undoubtedly an <em>impeccable</em> library. But learning it was not for the faint of heart as far as I'm concerned. I failed to build any encompassing mental models of it even after I'd read the <a href="https://prosemirror.net/docs/guide/">guide</a> several times. The only way I could make progress from there was by cross-referencing existing code examples and the <a href="https://prosemirror.net/docs/ref/">manual</a>, and trial-and-error from there. And if I exhausted that too, then I would ask in the forum and it's always answered. I wouldn't bother with StackOverflow unless maybe for the popular Quilljs.</p>
<p>These were the places I went scrounging for code samples:</p>
<ul>
<li>The <a href="https://prosemirror.net/examples/">official examples</a></li>
<li>Search the <a href="https://discuss.prosemirror.net/">forum</a></li>
<li>'Fork' <a href="https://github.com/prosemirror/prosemirror-example-setup">prosemirror-example-setup</a></li>
<li>An editor called <a href="https://tiptap.scrumpy.io/">tiptap</a> that's based on Prosemirror but built for Vuejs. The codebase actually has very few bits of Vuejs. So you can find lots of helpful Prosemirror-specific snippets there(thanks guys!).</li>
</ul>
<p>In keeping with the spirit of this learning journey, I have extracted the rich-text editor of Sametable in a CodeSandBox:</p>
<p><a href="https://codesandbox.io/s/compassionate-montalcini-gcgwc">https://codesandbox.io/s/compassionate-montalcini-gcgwc</a></p>
<p>üôå</p>
<h2>CORS <a href="#cors" id="cors">#</a></h2>
<p>To stop your browser from complaining about CORS issues, it's <a href="https://medium.com/@kilgarenone/deploy-your-nodejs-app-to-digital-ocean-1de40797666f#4aa4">all about</a> getting your backend to send those <code>Access-Control-Allow-*</code> headers back per request. (Apologies for oversimplification is in order)</p>
<p>But, correct me if I'm wrong, there's <a href="https://stackoverflow.com/a/60502433/73323">no way</a> to configure CORS in GAE itself. So I had to do it with the <a href="https://www.npmjs.com/package/cors">cors</a> npm package:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"express"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> cors <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"cors"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token constant">ALLOWED_ORIGINS</span> <span class="token operator">=</span> <span class="token punctuation">[</span><br>  <span class="token string">"http://localhost:8008"</span><span class="token punctuation">,</span><br>  <span class="token string">"https://web.sametable.app"</span><span class="token punctuation">,</span> <span class="token comment">// your SPA's domain</span><br><span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><br>  <span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    credentials<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// include Access-Control-Allow-Credentials: true. remember set xhr.withCredentials = true;</span><br>    <span class="token function">origin</span><span class="token punctuation">(</span><span class="token parameter">origin<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token comment">// allow requests with no origin</span><br>      <span class="token comment">// (like mobile apps or curl requests)</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>origin<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">ALLOWED_ORIGINS</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">const</span> msg <span class="token operator">=</span><br>          <span class="token string">"The CORS policy for this site does not "</span> <span class="token operator">+</span><br>          <span class="token string">"allow access from the specified Origin."</span><span class="token punctuation">;</span><br>        <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>      <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h2>Hosting Your SPA <a href="#hosting-spa" id="hosting-spa">#</a></h2>
<p>When I was still on Lightsail, my SPA was <a href="https://medium.com/@kilgarenone/deploy-spa-to-aws-9302796acd88">hosted</a> on S3+Cloudfront because I assumed it's better to keep them under the same platform for better latency. Then I found GCP. As a beat refugee from AWS landing in GCP, I first explored the 'Cloud Storage' to host my SPA, and turns out it wasn't ideal for SPA. It's rather convoluted. So you can skip that.</p>
<p>Then I tried hosting my SPA in <a href="https://firebase.google.com/docs/hosting/quickstart"><strong>Firebase</strong></a>. Easily done in minutes even when it was my first time there. I love it.</p>
<p>Another option you can consider is <a href="https://netlify.com">Netlify</a> which is super easy to get started too.</p>
<h2>Payment &amp; Subscription <a href="#payment-subscription" id="payment-subscription">#</a></h2>
<p>A SaaS usually allows users to pay and subscribe to access the paid features you have designated.</p>
<p>To enable that possibility in Sametable, I use <strong>Stripe</strong> to handle both the payment and subscription flows.</p>
<h3>Guide <a href="#payment-subscription-guide" id="payment-subscription-guide">#</a></h3>
<p>There are two ways to implement them:</p>
<ol>
<li><a href="https://stripe.com/docs/billing/subscriptions/fixed-price">Very hands-on</a> that's great for customizing your UI.</li>
<li><a href="https://stripe.com/docs/payments/checkout/set-up-a-subscription"><strong>Checkout</strong></a>. Fastest to implement. This was what I went for.</li>
</ol>
<h3>Webhook <a href="#payment-subscription-webhook" id="payment-subscription-webhook">#</a></h3>
<p>The last key component I needed for this piece was a 'webhook' which is basically just a typical endpoint in your Nodejs that can be called by a third-party such as Stripe.</p>
<p>I created a webhook that will be called when a payment has been charged successfully to signify in the user record that corresponds to the payee as a PRO user in Sametable from there onwards:</p>
<pre class="language-javascript"><code class="language-javascript">router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><br>  <span class="token string">"/webhook/payment_success"</span><span class="token punctuation">,</span><br>  bodyParser<span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">"application/json"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> sig <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"stripe-signature"</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">let</span> event<span class="token punctuation">;</span><br><br>    <span class="token keyword">try</span> <span class="token punctuation">{</span><br>      event <span class="token operator">=</span> stripe<span class="token punctuation">.</span>webhooks<span class="token punctuation">.</span><span class="token function">constructEvent</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">,</span> sig<span class="token punctuation">,</span> webhookSecret<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Webhook Error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// Handle the checkout.session.completed event</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"checkout.session.completed"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token comment">// 'session' doc: https://stripe.com/docs/api/checkout/sessions/object</span><br>      <span class="token keyword">const</span> session <span class="token operator">=</span> event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>object<span class="token punctuation">;</span><br><br>      <span class="token comment">// here you can query your database to, for example,</span><br>      <span class="token comment">// update a particular user/tenant's record</span><br><br>      <span class="token comment">// Return a res to acknowledge receipt of the event</span><br>      res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> received<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h4>Reference</h4>
<p>Here is a code snippet of a webhook:
<a href="https://stripe.com/docs/webhooks/signatures#verify-official-libraries">https://stripe.com/docs/webhooks/signatures#verify-official-libraries</a></p>
<h4>Guide</h4>
<ul>
<li><a href="https://stripe.com/docs/webhooks">https://stripe.com/docs/webhooks</a></li>
</ul>
<h2>Landing page <a href="#landing-page" id="landing-page">#</a></h2>
<h3>Building <a href="#building-landing-page" id="building-landing-page">#</a></h3>
<p>I use <a href="https://www.11ty.dev/"><strong>Eleventy</strong></a> to build the landing page of Sametable. I <a href="https://twitter.com/devongovett/status/1222953655722110981">wouldn't</a> recommend Gatsby or Nextjs. They are overkill for this job.</p>
<p>I started with one of the <a href="https://www.11ty.dev/docs/starter/">starter projects</a> as I was impatient to get my page off the ground. But I struggled working in them. Although Eleventy claims to be a simple SSG, there are actually quite a few concepts to grasp if you are new to <a href="https://www.staticgen.com/">static site generators</a>(SSG). Coupled with the tools introduced by the starter kits, things can get complex. So I decided to start from zero and take my time reading the doc from start to finish, slowly building up. Quiet and easy.</p>
<h4>Guides</h4>
<ul>
<li><strong>Long version</strong>
<ul>
<li><a href="https://tatianamac.com/posts/beginner-eleventy-tutorial-parti/">https://tatianamac.com/posts/beginner-eleventy-tutorial-parti/</a></li>
<li><a href="https://www.11ty.dev/docs/">https://www.11ty.dev/docs/</a></li>
</ul>
</li>
<li><strong>Short version</strong>: <a href="https://github.com/kilgarenone/personal-website">https://github.com/kilgarenone/personal-website</a> (the first website I built as my personal site while learning 11ty. It has a homepage and blog posts. Very few concepts introduced here. You could start with this 'starter project')</li>
</ul>
<h3>Hosting <a href="#hosting-landing-page" id="hosting-landing-page">#</a></h3>
<p>I use <a href="https://www.netlify.com/"><strong>Netlify</strong></a> to host the landing page. There are also <a href="https://surge.sh/">surge.sh</a> and <a href="https://vercel.com">Vercel</a>. You will be fine here.</p>
<h2>Terms and Conditions <a href="#tnc" id="tnc">#</a></h2>
<p>T&amp;C makes your SaaS legit. As far as I know, here are your options to come up with them:</p>
<ol>
<li>Write your own <a href="https://pinboard.in/tos/">https://pinboard.in/tos/</a>.</li>
<li>Copy and paste others'. Change accordingly. Never easy in my experience.</li>
<li>Lawyer up.</li>
<li>Generate them in <a href="https://getterms.io/"><strong>getterms.io</strong></a>.</li>
</ol>
<h2>Marketing <a href="#marketing" id="marketing">#</a></h2>
<p>There is no shortage of marketing posts saying it was a bad idea to &quot;<em>Let the product speaks for itself</em>&quot;. Well, not unless you are trying to 'hack growth' to win the game.</p>
<p>The following is the trajectory of existence I have in mind for Sametable:</p>
<ol>
<li>Build something that purportedly solves a problem.</li>
<li>Do your SEO. Write the blog posts. Anyone who is affected by the problem that you have solved for will search for it, or know about it by word of mouth.</li>
<li>If it still didn't take off, well, chances are you weren't solving a huge real problem, or enough people have already solved it. In that case, just be grateful for whatever success that comes your way over the long haul.</li>
</ol>
<h3>Resources</h3>
<ul>
<li><a href="https://stripe.com/en-my/atlas/guides/starting-sales">https://stripe.com/en-my/atlas/guides/starting-sales</a></li>
<li><a href="https://github.com/LisaDziuba/Marketing-for-Engineers">https://github.com/LisaDziuba/Marketing-for-Engineers</a></li>
<li><a href="https://github.com/LisaDziuba/Marketing-for-Engineers">https://www.coryzue.com/writing/seo-for-developers/</a></li>
</ul>
<h2>Well-being <a href="#well-being" id="well-being">#</a></h2>
<p>It's easy to sit and get lost in our contemporary works. And we do that by accumulating debts from the future. One of the debts is our personal <strong>health</strong>.</p>
<p>Here is how I try to stay on top of my health debt:</p>
<ul>
<li><strong>Install</strong> <a href="https://workrave.org/"><strong>Workrave</strong></a>
You can set it to lock your screen after an interval has passed. Most importantly, it can show some exercises that you can perform behind your computer!</li>
<li>Get an adjustable <strong>standing desk</strong> if you can afford it. I got mine from IKEA.</li>
<li>Do <a href="https://www.youtube.com/watch?v=Kjhl-8yU6hI"><strong>burpees</strong></a>. Stretch those joints. Maintain good posture. <a href="https://www.youtube.com/watch?v=59MaNHq8UDo">Planking</a> helps.</li>
<li><strong>Meditate</strong> to stay sane. I'm using <a href="https://meditofoundation.org/">Medito</a>.</li>
</ul>
<p>üåàüåª</p>

  </article>
</main>

  </body>
</html>
